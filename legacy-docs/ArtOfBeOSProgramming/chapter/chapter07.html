
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html lang="Ja">

<!-- Mirrored from www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/chapter07.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 05 Aug 2021 01:43:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<title>Art of BeOS Programming</title>
	<link href="../css/format.css" rel="stylesheet" type="text/css">
	<link href="../css/layout.css" rel="stylesheet" type="text/css">
</head>

<body>

<div id="pagewidth">

<div id="main">

<br/>

<h1>第7章 もっと動きを</h1>
<br/>

この章では、アニメーション表示を行って動きのある画面を作ります。つまり、題材として以下のものをとりあげます。<br/>

<br/>

 ◇動きのある画面表示、つまりアニメーションの描画<br/>

 ◇画面更新時のちらつきを抑えるための、オフスクリーン描画<br/>

 ◇二つのウィンドウで行われる処理のタイミングを合わせるのに必要な、イベント<br/>

  スケジューリング<br/>

<br/>

これらの題材をプログラミングするために、BeOSのAPIが提供しているクラスのうち、主に以下のものを利用します。<br/>

<br/>

 ●BView(Interface Kit)<br/>

 ●BBitmap(Interface Kit)<br/>

 ●BLooper(Application Kit)<br/>

<br/>

これらのクラスの間の階層関係を、図7.1に示します。<br/>

<br/>

<div id="imagebox">
<img src="img/7.01.jpg" alt="図 第7章で主に扱うクラス間の階層図"/><div>図[7.1]  第7章で主に扱うクラス間の階層図</div>
</div>

<br/>

プログラミングの説明に使うサンプルアプリケーションは、全部で二つ用意しています。7.1節では、画面の更新や再描画のことを深く考えないバージョンのアプリケーションを作り、次に7.2節でそれを改良します。サンプルで扱うアニメーションはとても簡単なものですが、この章の説明を読んでBeOSのAPIをどう利用すればよいのかを理解すれば、高度な処理にも応用できるでしょう。<br/>

<br/>

<br/>
<a name="7.1"></a>
<h2>7.1&nbsp;&nbsp;時計じかけのアニメーション</h2>
<br/>
<a name="7.1.1"></a>
<h3>7.1.1&nbsp;&nbsp;サンプルの機能と構造</h3>
アニメーション表示を行うためのプログラミングを解説する前に、まずはサンプルアプリケーションについて見ておきましょう。図7.2が、この章で使う“ClockworkWave”という名前のサンプルを動かした様子です。<br/>

<br/>

<div id="imagebox">
<img src="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/img/7.02.jpg" alt="図 ClockworkWaveのスクリーンショット"/><div>図[7.2]  ClockworkWaveのスクリーンショット</div>
</div>

<br/>

次に、このアプリケーションの機能、つまりClockworkWaveの外部仕様を述べます。<br/>

<br/>

 ・起動すると二つのウィンドウを開く。どちらのウィンドウにもメニューバーがあり、"File"メニューから"Quit"項目を選んでアプリケーションを終了できる。また、アバウト項目を選ぶとアバウトダイアログを表示する。<br/>

<br/>

 ・二つのウィンドウのうち、一方には現在時刻を秒単位で表示する。なお、表示はデジタル形式で行い、一秒ごとに表示内容を更新する。<br/>

<br/>

 ・もう一方のウィンドウには、中心から外側に向けて拡がっていく波紋のアニメーションを表示する。また、波紋の色を4秒ごとに変化させる。<br/>

<br/>

 ・ウィンドウを二つとも閉じると、アプリケーションが自動的に終了する。また、一方のウィンドウを閉じるか、または最小化して隠しても、もう一方のウィンドウのメニュー項目を選ぶと開き直すことができる。<br/>

<br/>

上に書いた外部仕様と、図7.2のスクリーンショットからでは実際の動きが分からないかも知れませんね。その場合は、付録に付けたサンプルコード集からClockworkWaveのソースファイルやプロジェクトファイルをコピーし、アプリケーションを作成して動かしてみて下さい。サンプルコード集の中の“7.1_ClockworkWave”というのが、ClockworkWaveの最初のバージョンのフォルダです。また、“7.2_ClockworkWaveR”というのは、この次の7.2節で説明する改良バージョンのフォルダです。できれば両方一度にコピーし、動きの違いを観察してみて下さい。<br/>

<br/>

なお、本章のサンプルからは、それぞれのサンプル間で共通に利用するソースをライブラリとしてフォルダにまとめています。“MyLib”というのが、そのライブラリを収録したフォルダです。ClockworkWaveアプリケーションを作成する場合は、このフォルダを一緒にコピーしないと作成できませんので注意して下さい。つまり“7.1_ClockworkWave”フォルダや“7.2_ClockworkWaveR”フォルダをコピーする時は、必ず“MyLib”フォルダも一緒にコピーする必要があります。<br/>

<br/>

ClockworkWaveアプリケーションの動きが分かったら、次はその内部を見てみましょう。図7.3に、ClockworkWaveのモジュール構成を示します。<br/>

<br/>

<div id="imagebox">
<img src="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/img/7.03.jpg" alt="図 ClockworkWaveのモジュール構成図"/><div>図[7.3]  ClockworkWaveのモジュール構成図</div>
</div>

<br/>

図7.3に示したモジュールのうち、中心的な役割を果たすのはClockViewクラスとWaveViewクラス、そしてTimeKeeperクラスです。ClockViewクラスは時刻表示を行うビュークラスで、WaveViewクラスは波紋のアニメーション表示を行うビュークラスです。また、TimeKeeperクラスはイベントスケジューリングを行うクラスで、BLooperのサブクラスとして実装しています。図7.3に示したそれぞれのクラスの概要を、以下に述べます。<br/>

<br/>

 ■ClockworkWaveAppクラス<br/>

  ClockworkWaveのアプリケーションクラス。BApplicationクラスのメソッドのうち、フック関数として提供されているReadyToRun()とMessageReceived()、それにAboutRequested()を実装し、またQuit()メソッドを再定義しています。自分以外のモジュールを生成し、それらを管理するのが主な役割です。ウィンドウが二つとも閉じられたとき、自動的にアプリケーションを終了するのは、ClockworkWaveAppクラスとRegularWindowクラスの連携によるものです。<br/>

<br/>

 ■RegularWindowクラス<br/>

  ウィンドウクラスです。BWindowクラスのメソッドのうち、Quit()メソッドを再定義しています。前の第6章の説明で使ったSingleWindowクラスやSmartWindowクラスを発展させたもので、ウィンドウが閉じる時にアプリケーションへ送るメッセージコードを、コンストラクタに渡す引数で設定できるのが特徴です。なお、これ以降に登場するサンプルアプリケーションは全てRegularWindowクラスを利用しています。このため、サンプルコード集では、RegularWindowクラスのソースをライブラリ用のフォルダ(“MyLib”)に収録しています。<br/>

<br/>

 ■ClockViewクラス<br/>

  時刻表示を行うビュークラスです。TimeKeeperオブジェクトを利用して、1秒ごとに表示内容を更新します。BViewクラスが提供しているフック関数のうち、AttachedToWindow()とDeatchedFromWinodw()、およびDraw()とMessageReceived()を実装しています。<br/>

<br/>

 ■WaveViewクラス<br/>

  波紋のアニメーション表示を行うクラスです。TimeKeeperオブジェクトを利用して、4秒ごとに波紋の色を変更します。アニメーション表示は、BWindowクラスとBViewクラスの連携機構を利用し、十分短い間隔でPulse()メソッドを呼び出させて行います。BViewクラスが提供しているフック関数のうち、AttachedToWindow()とDeatchedFromWindow()、およびPulse()を実装しています。なお、Pulse()メソッドについては7.1.3で詳しく説明します。<br/>

<br/>

 ■TimeKeeperクラス<br/>

  イベントスケジューリング機能を提供するクラスです。監視用のスレッドを使って、イベントを発生させる時刻に達しているかどうかを定期的に調べ、その時刻に達したらイベントを起こします。TimeKeeperクラスでは、イベントを起こすというのは前もって指定されたターゲットにメッセージを送ることです。前述したClockViewクラスとWaveViewクラスは、それぞれTimeKeeperオブジェクトにイベントを登録し、自分が望む周期でメッセージを送ってもらいます。そして、送られたメッセージに従って時刻の表示を更新したり、また波紋と水面の色を変更するのです。<br/>

<br/>

<br/>
<a name="7.1.2"></a>
<h3>7.1.2&nbsp;&nbsp;サンプルのソースコード</h3>
前述した、ClockworkWaveアプリケーションを構成するクラスのうち、TimeKeeper以外のもののソースをリスト7.1～7.8に示します。TimeKeeperクラスの説明は7.3節で行うため、ここではソースを示しません。ビュークラスやアプリケーションクラスなど、まずは目に見える部分の動きを司っているものの働きを見ておきましょう。<br/>

<br/>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.1] ClockworkWaveApp.h</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _CLOCKWORK_WAVE_APP_H_
<b><font color="#000080">#define</font></b> _CLOCKWORK_WAVE_APP_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;app/Application.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 関連クラス・構造体 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b>	RegularWindow<font color="#990000">;</font>
<b><font color="#0000FF">class</font></b>	TimeKeeper<font color="#990000">;</font>
<b><font color="#0000FF">class</font></b>	BMenuBar<font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ClockworkWaveAppクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> ClockworkWaveApp <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> BApplication <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">ClockworkWaveApp</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">~</font><b><font color="#000000">ClockworkWaveApp</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 起動と終了</font></i>
    <font color="#009900">void</font>		<b><font color="#000000">ReadyToRun</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>		<b><font color="#000000">Quit</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> ビュー部品の生成</font></i>
    <font color="#009900">void</font>		<b><font color="#000000">MakeClockWin</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>		<b><font color="#000000">MakeWaveWin</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    BMenuBar<font color="#990000">*</font>	<b><font color="#000000">MakeMenuBar</font></b><font color="#990000">(</font><font color="#009900">bool</font> forClock<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メニューの応答</font></i>
    <font color="#009900">void</font>		<b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>		<b><font color="#000000">AboutRequested</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>		<b><font color="#000000">CheckWindow</font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>		<b><font color="#000000">ShowClock</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>		<b><font color="#000000">ShowWave</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> ウィンドウ操作</font></i>
    <font color="#009900">void</font>		<b><font color="#000000">ShowWindow</font></b><font color="#990000">(</font>BWindow<font color="#990000">*</font> inWindow<font color="#990000">)</font><font color="#990000">;</font>

<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    RegularWindow<font color="#990000">*</font> fClockWin<font color="#990000">;</font>   <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 時計表示のウィンドウ </font></i><i><font color="#9A1900">*/</font></i>
    RegularWindow<font color="#990000">*</font> fWaveWin<font color="#990000">;</font>    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 水面表示のウィンドウ </font></i><i><font color="#9A1900">*/</font></i>
    TimeKeeper<font color="#990000">*</font>    fTimeKeeper<font color="#990000">;</font> <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> タイミング動作用 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _CLOCKWORK_WAVE_APP_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.2] ClockworkWaveApp.cp</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"ClockworkWaveApp.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"ClockView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"WaveView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"GUI/RegularWindow.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"KGUtility/kgDebug.h"</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Alert.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/MenuBar.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/MenuItem.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Autolock.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージのコード </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">enum</font></b> <font color="#FF0000">{</font>
    WINDOW_CLOSED <font color="#990000">=</font> <font color="#FF0000">'wcld'</font><font color="#990000">,</font>
    SHOW_CLOCK    <font color="#990000">=</font> <font color="#FF0000">'sclk'</font><font color="#990000">,</font>
    SHOW_WAVE     <font color="#990000">=</font> <font color="#FF0000">'swav'</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> アバウトダイアログのメッセージ </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">const</font></b> <font color="#009900">char</font>	kAboutMsg<font color="#990000">[</font><font color="#990000">]</font>	<font color="#990000">=</font> <font color="#FF0000">"ClockworkWave\n\n"</font>
    <font color="#FF0000">"Copyright "</font> B_UTF8_COPYRIGHT <font color="#FF0000">" 1997-1998 Fort Gunnison, Inc.\n"</font>
    <font color="#FF0000">"Author: Shin'ya Koga (koga@ftgun.co.jp)"</font><font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> ClockworkWaveAppクラスの非公開メソッド </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 起動と終了; ClockworkWaveApp</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ReadyToRun </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> TimeKeeperオブジェクトを生成して起動 </font></i><i><font color="#9A1900">*/</font></i>
    fTimeKeeper <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TimeKeeper</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Run</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 二つのウィンドウを生成して表示 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MakeClockWin</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MakeWaveWin</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Quit </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> TimeKeeperオブジェクトを停止して解放 </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Lock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Quit</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 親クラスのメソッドを実行 </font></i><i><font color="#9A1900">*/</font></i>
    BApplication<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Quit</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ビュー部品の生成; ClockworkWaveApp</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MakeClockWin </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BMenuBar<font color="#990000">*</font> aMenuBar<font color="#990000">;</font>
    BView<font color="#990000">*</font>    aView<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 時計を表示するウィンドウを生成して表示 </font></i><i><font color="#9A1900">*/</font></i>
    fClockWin <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">RegularWindow</font></b><font color="#990000">(</font>
        <b><font color="#000000">BRect</font></b><font color="#990000">(</font><font color="#993399">50</font><font color="#990000">,</font> <font color="#993399">50</font><font color="#990000">,</font> <font color="#993399">200</font><font color="#990000">,</font> <font color="#993399">140</font><font color="#990000">)</font><font color="#990000">,</font>
        <font color="#FF0000">"Clock Window"</font><font color="#990000">,</font>
        B_TITLED_WINDOW<font color="#990000">,</font>
        <font color="#993399">0</font><font color="#990000">,</font>
        WINDOW_CLOSED
    <font color="#990000">)</font><font color="#990000">;</font>
    aMenuBar <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MakeMenuBar</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">)</font><font color="#990000">;</font>
    aView <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">ClockView</font></b><font color="#990000">(</font>
        <b><font color="#000000">BRect</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">,</font> B_FOLLOW_ALL_SIDES<font color="#990000">,</font> fTimeKeeper
    <font color="#990000">)</font><font color="#990000">;</font>
    aView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetViewColor</font></b><font color="#990000">(</font><font color="#993399">0xD0</font><font color="#990000">,</font> <font color="#993399">0xD0</font><font color="#990000">,</font> <font color="#993399">0xD0</font><font color="#990000">)</font><font color="#990000">;</font>
    fClockWin<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">InitContent</font></b><font color="#990000">(</font>aMenuBar<font color="#990000">,</font> aView<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MakeWaveWin </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BMenuBar<font color="#990000">*</font> aMenuBar<font color="#990000">;</font>
    BView<font color="#990000">*</font>    aView<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 水面を表示するウィンドウを生成して表示 </font></i><i><font color="#9A1900">*/</font></i>
    fWaveWin  <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">RegularWindow</font></b><font color="#990000">(</font>
        <b><font color="#000000">BRect</font></b><font color="#990000">(</font><font color="#993399">250</font><font color="#990000">,</font> <font color="#993399">200</font><font color="#990000">,</font> <font color="#993399">450</font><font color="#990000">,</font> <font color="#993399">400</font><font color="#990000">)</font><font color="#990000">,</font>
        <font color="#FF0000">"Wave Window"</font><font color="#990000">,</font>
        B_TITLED_WINDOW<font color="#990000">,</font>
        B_NOT_RESIZABLE<font color="#990000">|</font>B_NOT_ZOOMABLE<font color="#990000">,</font>
        WINDOW_CLOSED
    <font color="#990000">)</font><font color="#990000">;</font>
    aMenuBar <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MakeMenuBar</font></b><font color="#990000">(</font><b><font color="#0000FF">false</font></b><font color="#990000">)</font><font color="#990000">;</font>
    aView <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">WaveView</font></b><font color="#990000">(</font>
        <b><font color="#000000">BRect</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">,</font> B_FOLLOW_ALL_SIDES<font color="#990000">,</font> fTimeKeeper
    <font color="#990000">)</font><font color="#990000">;</font>
    fWaveWin<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">InitContent</font></b><font color="#990000">(</font>aMenuBar<font color="#990000">,</font> aView<font color="#990000">)</font><font color="#990000">;</font>

    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

BMenuBar<font color="#990000">*</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MakeMenuBar </font></b><font color="#990000">(</font><font color="#009900">bool</font> forClock<font color="#990000">)</font>
<font color="#FF0000">{</font>
    BMenuBar<font color="#990000">*</font> theMenuBar<font color="#990000">;</font>
    BMenu<font color="#990000">*</font>    theFileMenu<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メニューバーと「File」メニューを生成 </font></i><i><font color="#9A1900">*/</font></i>
    theMenuBar <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMenuBar</font></b><font color="#990000">(</font><b><font color="#000000">BRect</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">,</font> B_EMPTY_STRING<font color="#990000">)</font><font color="#990000">;</font>
    theFileMenu <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMenu</font></b><font color="#990000">(</font><font color="#FF0000">"File"</font><font color="#990000">)</font><font color="#990000">;</font>
    theMenuBar<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddItem</font></b><font color="#990000">(</font>theFileMenu<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> about項目 </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddItem</font></b><font color="#990000">(</font>
        <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMenuItem</font></b><font color="#990000">(</font>
        <font color="#FF0000">"About ClockworkWave"</font> B_UTF8_ELLIPSIS<font color="#990000">,</font>
        <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>B_ABOUT_REQUESTED<font color="#990000">)</font>
    <font color="#990000">)</font>
    <font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> -- </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddSeparatorItem</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> ウィンドウ表示項目 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>forClock<font color="#990000">)</font> <font color="#FF0000">{</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddItem</font></b><font color="#990000">(</font>
            <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMenuItem</font></b><font color="#990000">(</font>
                <font color="#FF0000">"Show Wave"</font><font color="#990000">,</font>
                <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>SHOW_WAVE<font color="#990000">)</font>
            <font color="#990000">)</font>
        <font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddItem</font></b><font color="#990000">(</font>
            <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMenuItem</font></b><font color="#990000">(</font>
                <font color="#FF0000">"Show Clock"</font><font color="#990000">,</font>
                <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>SHOW_CLOCK<font color="#990000">)</font>
            <font color="#990000">)</font>
        <font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> -- </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddSeparatorItem</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> Quit項目 </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddItem</font></b><font color="#990000">(</font>
        <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMenuItem</font></b><font color="#990000">(</font>
            <font color="#FF0000">"Quit"</font><font color="#990000">,</font>
            <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>B_QUIT_REQUESTED<font color="#990000">)</font><font color="#990000">,</font>
            <font color="#FF0000">'Q'</font>
        <font color="#990000">)</font>
    <font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メニューのターゲットを設定 </font></i><i><font color="#9A1900">*/</font></i>
    theFileMenu<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetTargetForItems</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b> theMenuBar<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メニュー応答; ClockworkWaveApp</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived </font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">case</font></b> WINDOW_CLOSED<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">CheckWindow</font></b><font color="#990000">(</font>message<font color="#990000">)</font><font color="#990000">;</font> <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">case</font></b> SHOW_CLOCK<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ShowClock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>          <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">case</font></b> SHOW_WAVE<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ShowWave</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>           <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
        BApplication<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AboutRequested </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BAlert<font color="#990000">*</font>	alertPanel<font color="#990000">;</font>
	
    alertPanel <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BAlert</font></b><font color="#990000">(</font><font color="#FF0000">"about box"</font><font color="#990000">,</font> kAboutMsg<font color="#990000">,</font> <font color="#FF0000">"OK"</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>alertPanel<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Go</font></b><font color="#990000">(</font>NULL<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">CheckWindow </font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t	sts<font color="#990000">;</font>
    BWindow<font color="#990000">*</font>	sender<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 終了したウィンドウを記録 </font></i><i><font color="#9A1900">*/</font></i>	
    sts <font color="#990000">=</font> message<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FindPointer</font></b><font color="#990000">(</font>kSender<font color="#990000">,</font> <font color="#990000">&amp;</font>sender<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sender <font color="#990000">=</font><font color="#990000">=</font> fClockWin<font color="#990000">)</font>
        fClockWin <font color="#990000">=</font> NULL<font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sender <font color="#990000">=</font><font color="#990000">=</font> fWaveWin<font color="#990000">)</font>
        fWaveWin <font color="#990000">=</font> NULL<font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        sts <font color="#990000">=</font> B_ERROR<font color="#990000">;</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 全てのウィンドウが閉じられた場合は終了 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fClockWin <font color="#990000">=</font><font color="#990000">=</font> NULL <font color="#990000">&amp;</font><font color="#990000">&amp;</font> fWaveWin <font color="#990000">=</font><font color="#990000">=</font> NULL<font color="#990000">)</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">PostMessage</font></b><font color="#990000">(</font>B_QUIT_REQUESTED<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"ClockworkWaveApp::CheckWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ShowClock </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fClockWin <font color="#990000">=</font><font color="#990000">=</font> NULL<font color="#990000">)</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MakeClockWin</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ShowWindow</font></b><font color="#990000">(</font>fClockWin<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ShowWave </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fWaveWin <font color="#990000">=</font><font color="#990000">=</font> NULL<font color="#990000">)</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MakeWaveWin</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ShowWindow</font></b><font color="#990000">(</font>fWaveWin<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ウィンドウ操作; ClockworkWaveApp</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ShowWindow </font></b><font color="#990000">(</font>BWindow<font color="#990000">*</font> inWindow<font color="#990000">)</font>
<font color="#FF0000">{</font>
    BAutolock	<b><font color="#000000">lock</font></b><font color="#990000">(</font>inWindow<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inWindow<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsHidden</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font>
        inWindow<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Show</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#990000">!</font> inWindow<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsActive</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font>
        inWindow<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Activate</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ClockworkWaveAppクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ClockworkWaveApp </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">BApplication</font></b><font color="#990000">(</font><font color="#FF0000">"application/x-vnd.FtGUN-ClockworkWave"</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    fClockWin <font color="#990000">=</font> fWaveWin <font color="#990000">=</font> NULL<font color="#990000">;</font>
    fTimeKeeper <font color="#990000">=</font> NULL<font color="#990000">;</font>
<font color="#FF0000">}</font>

ClockworkWaveApp<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">ClockworkWaveApp </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> do nothing </font></i><i><font color="#9A1900">*/</font></i>  <font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.3] RegularWindow.h</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _REGULAR_WINDOW_H_
<b><font color="#000080">#define</font></b> _REGULAR_WINDOW_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Window.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 文字列定数 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">extern</font></b> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font>	kSender<font color="#990000">[</font><font color="#990000">]</font><font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * RegularWindowのクラス定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> RegularWindow <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> BWindow <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">RegularWindow</font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*</font> title<font color="#990000">,</font>
        window_type type<font color="#990000">,</font> uint32 flags<font color="#990000">,</font> uint32 quitMsg<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">virtual</font></b> <font color="#990000">~</font><b><font color="#000000">RegularWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">virtual</font></b> <font color="#009900">void</font>	<b><font color="#000000">InitContent</font></b><font color="#990000">(</font>BView<font color="#990000">*</font> inContent<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">virtual</font></b> <font color="#009900">void</font>	<b><font color="#000000">InitContent</font></b><font color="#990000">(</font>BMenuBar<font color="#990000">*</font> inMenuBar<font color="#990000">,</font> BView<font color="#990000">*</font> inContent<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 終了時処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">Quit</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    uint32	fQuitMsg<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 終了通知メッセージのコード </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _REGULAR_WINDOW_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.4] RegularWindow.cp</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"RegularWindow.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;app/Application.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/MenuBar.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Debug.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 文字列定数 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">const</font></b> <font color="#009900">char</font>	kSender<font color="#990000">[</font><font color="#990000">]</font>	<font color="#990000">=</font> <font color="#FF0000">"sender"</font><font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * RegularWindowクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
RegularWindow<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">RegularWindow </font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*</font> title<font color="#990000">,</font>
        window_type type<font color="#990000">,</font> uint32 flags<font color="#990000">,</font> uint32 quitMsg<font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">BWindow</font></b><font color="#990000">(</font>frame<font color="#990000">,</font> title<font color="#990000">,</font> type<font color="#990000">,</font> flags<font color="#990000">,</font> B_CURRENT_WORKSPACE<font color="#990000">)</font>
<font color="#FF0000">{</font>
    fQuitMsg <font color="#990000">=</font> quitMsg<font color="#990000">;</font>
<font color="#FF0000">}</font>

RegularWindow<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">RegularWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> do nothing </font></i><i><font color="#9A1900">*/</font></i>  <font color="#FF0000">}</font>

<font color="#009900">void</font>
RegularWindow<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">InitContent </font></b><font color="#990000">(</font>BView<font color="#990000">*</font> inContent<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> DEBUG
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Lock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsHidden</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">CountChildren</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">=</font><font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Unlock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>

    BRect	myBounds <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    inContent<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ResizeTo</font></b><font color="#990000">(</font>myBounds<font color="#990000">.</font><b><font color="#000000">Width</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">,</font> myBounds<font color="#990000">.</font><b><font color="#000000">Height</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddChild</font></b><font color="#990000">(</font>inContent<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Show</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
RegularWindow<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">InitContent </font></b><font color="#990000">(</font>BMenuBar<font color="#990000">*</font> inMenuBar<font color="#990000">,</font> BView<font color="#990000">*</font> inContent<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> DEBUG
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Lock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsHidden</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">CountChildren</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">=</font><font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Unlock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>

    BRect	myBounds <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    BRect	mbarFrame<font color="#990000">;</font>
	
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddChild</font></b><font color="#990000">(</font>inMenuBar<font color="#990000">)</font><font color="#990000">;</font>
    mbarFrame <font color="#990000">=</font> inMenuBar<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Frame</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    inContent<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ResizeTo</font></b><font color="#990000">(</font>
        myBounds<font color="#990000">.</font><b><font color="#000000">Width</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">,</font> myBounds<font color="#990000">.</font><b><font color="#000000">Height</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">-</font> mbarFrame<font color="#990000">.</font><b><font color="#000000">Height</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">)</font><font color="#990000">;</font>
    inContent<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">MoveBy</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> mbarFrame<font color="#990000">.</font><b><font color="#000000">Height</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddChild</font></b><font color="#990000">(</font>inContent<font color="#990000">)</font><font color="#990000">;</font>	
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Show</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 終了時処理; RegularWindow</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
RegularWindow<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Quit </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BMessage	<b><font color="#000000">quitMessage</font></b><font color="#990000">(</font>fQuitMsg<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> アプリケーションに終了を通知 </font></i><i><font color="#9A1900">*/</font></i>
    quitMessage<font color="#990000">.</font><b><font color="#000000">AddPointer</font></b><font color="#990000">(</font>kSender<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>be_app<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">PostMessage</font></b><font color="#990000">(</font><font color="#990000">&amp;</font>quitMessage<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 親クラスのメソッドを実行 </font></i><i><font color="#9A1900">*/</font></i>
    BWindow<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Quit</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.5] ClockView.h</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _CLOCK_VIEW_H_
<b><font color="#000080">#define</font></b> _CLOCK_VIEW_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/View.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;time.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 関連クラス・構造体 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b>	TimeKeeper<font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ClockViewクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> ClockView <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> BView <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">ClockView</font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">~</font><b><font color="#000000">ClockView</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
	
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 描画処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">AttachedToWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">DetachedFromWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">Draw</font></b><font color="#990000">(</font>BRect updateRect<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メッセージ処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">UpdateTime</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
	
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    TimeKeeper<font color="#990000">*</font> fTimeKeeper<font color="#990000">;</font> <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> スケジューラ </font></i><i><font color="#9A1900">*/</font></i>
    tm          fTime<font color="#990000">;</font>       <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 現在時刻 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _CLOCK_VIEW_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.6] ClockView.cp</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"ClockView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"KGUtility/kgDebug.h"</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Debug.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;stdio.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージのコード </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">enum</font></b> <font color="#FF0000">{</font>
    UPDATE_TIME	<font color="#990000">=</font> <font color="#FF0000">'uptm'</font>
<font color="#FF0000">}</font><font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> ClockViewクラスの非公開メソッド  </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 描画処理; ClockView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AttachedToWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t     sts<font color="#990000">;</font>
    ScheduleInfo theSchedule<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> スケジュールを登録 </font></i><i><font color="#9A1900">*/</font></i>
    theSchedule<font color="#990000">.</font>client     <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>message    <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>UPDATE_TIME<font color="#990000">)</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>period     <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>first_time <font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">real_time_clock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    sts <font color="#990000">=</font> fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">InsertSchedule</font></b><font color="#990000">(</font>theSchedule<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 現在の時刻を取得 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateTime</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"ClockView::AttachedToWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">DetachedFromWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t	sts<font color="#990000">;</font>
	
    sts <font color="#990000">=</font> fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveSchedule</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">,</font> UPDATE_TIME<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"ClockView::DetachedFromWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Draw </font></b><font color="#990000">(</font>BRect <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> updateRect </font></i><i><font color="#9A1900">*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#009900">char</font>       timeStr<font color="#990000">[</font><font color="#993399">64</font><font color="#990000">]</font><font color="#990000">;</font>
    rgb_color  orgColor<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 全体をビューの色で塗りつぶしてクリア </font></i><i><font color="#9A1900">*/</font></i>
    orgColor  <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">HighColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ViewColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FillRect</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font><b><font color="#000000">orgColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 時刻表示文字列を描画 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetFontSize</font></b><font color="#990000">(</font><font color="#993399">30</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">sprintf</font></b><font color="#990000">(</font>timeStr<font color="#990000">,</font> <font color="#FF0000">"%02d:%02d:%02d"</font><font color="#990000">,</font>
        fTime<font color="#990000">.</font>tm_hour<font color="#990000">,</font> fTime<font color="#990000">.</font>tm_min<font color="#990000">,</font> fTime<font color="#990000">.</font>tm_sec<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">DrawString</font></b><font color="#990000">(</font>timeStr<font color="#990000">,</font> <b><font color="#000000">BPoint</font></b><font color="#990000">(</font><font color="#993399">18</font><font color="#990000">,</font> <font color="#993399">40</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メッセージ処理; ClockView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived </font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">case</font></b> UPDATE_TIME<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateTime</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
        BView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">UpdateTime </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    time_t	curTime <font color="#990000">=</font> <b><font color="#000000">time</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 時刻情報を更新 </font></i><i><font color="#9A1900">*/</font></i>
    fTime <font color="#990000">=</font> <font color="#990000">*</font><font color="#990000">(</font><b><font color="#000000">localtime</font></b><font color="#990000">(</font><font color="#990000">&amp;</font>curTime<font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 新しい時刻を描画 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Draw</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ClockViewクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ClockView </font></b><font color="#990000">(</font>
        BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">BView</font></b><font color="#990000">(</font>frame<font color="#990000">,</font> <font color="#FF0000">"ClockView"</font><font color="#990000">,</font> resizeMask<font color="#990000">,</font> B_WILL_DRAW<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font>inTimeKeeper <font color="#990000">!</font><font color="#990000">=</font> NULL<font color="#990000">)</font><font color="#990000">;</font>

    fTimeKeeper <font color="#990000">=</font> inTimeKeeper<font color="#990000">;</font>
    fTime<font color="#990000">.</font>tm_hour <font color="#990000">=</font> fTime<font color="#990000">.</font>tm_min <font color="#990000">=</font> fTime<font color="#990000">.</font>tm_sec <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

ClockView<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">ClockView </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> do nothing </font></i><i><font color="#9A1900">*/</font></i>  <font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.7] WaveView.h</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _WAVE_VIEW_H_
<b><font color="#000080">#define</font></b> _WAVE_VIEW_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/View.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 関連クラス・構造体 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b>	TimeKeeper<font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * WaveViewクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> WaveView <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> BView <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">WaveView</font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">~</font><b><font color="#000000">WaveView</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 描画処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">AttachedToWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">DetachedFromWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メッセージ処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">Pulse</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">UpdateColor</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
	
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    TimeKeeper<font color="#990000">*</font> fTimeKeeper<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> スケジューラ </font></i><i><font color="#9A1900">*/</font></i>
    uint8       fCurrColor<font color="#990000">;</font>		<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 水面の色 </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#009900">float</font>       fWaveRadius<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の半径 </font></i><i><font color="#9A1900">*/</font></i>
    BPoint      fWaveOrigin<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の中心 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _WAVE_VIEW_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.8] WaveView.cp</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"WaveView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"KGUtility/kgDebug.h"</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Screen.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Window.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Debug.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージのコード </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">enum</font></b> <font color="#FF0000">{</font>
    UPDATE_COLOR <font color="#990000">=</font> <font color="#FF0000">'upcl'</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> その他の定数 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">const</font></b> <font color="#009900">float</font>	kInitialRadius	<font color="#990000">=</font> <font color="#993399">10</font><font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋半径の初期値 </font></i><i><font color="#9A1900">*/</font></i>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> WaveViewクラスの非公開メソッド </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 描画処理; WaveView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AttachedToWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t     sts<font color="#990000">;</font>
    ScheduleInfo theSchedule<font color="#990000">;</font>
    BRect        myBounds <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> スケジュールを登録 </font></i><i><font color="#9A1900">*/</font></i>
    theSchedule<font color="#990000">.</font>client     <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>message    <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>UPDATE_COLOR<font color="#990000">)</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>period     <font color="#990000">=</font> <font color="#993399">4</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>first_time <font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">real_time_clock</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">+</font> <font color="#993399">4</font><font color="#990000">;</font>
    sts <font color="#990000">=</font> fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">InsertSchedule</font></b><font color="#990000">(</font>theSchedule<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 水面の色の初期値を設定 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetPulseRate</font></b><font color="#990000">(</font><font color="#993399">100</font> <font color="#990000">*</font> <font color="#993399">1000</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の原点座標を決定 </font></i><i><font color="#9A1900">*/</font></i>
    fWaveOrigin<font color="#990000">.</font>x <font color="#990000">=</font> myBounds<font color="#990000">.</font><b><font color="#000000">Width</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">2</font><font color="#990000">;</font>
    fWaveOrigin<font color="#990000">.</font>y <font color="#990000">=</font> myBounds<font color="#990000">.</font><b><font color="#000000">Height</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">2</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"WaveView::AttachedToWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">DetachedFromWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t	sts<font color="#990000">;</font>
	
    sts <font color="#990000">=</font> fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveSchedule</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">,</font> UPDATE_COLOR<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"WaveView::DetachedFromWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メッセージ処理; WaveView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived </font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">case</font></b> UPDATE_COLOR<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>	<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
        BView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Pulse </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BScreen   <b><font color="#000000">myScreen</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    rgb_color orgRGBColor <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">HighColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    uint8     waveColor<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の色を決定 </font></i><i><font color="#9A1900">*/</font></i>	
    waveColor <font color="#990000">=</font> myScreen<font color="#990000">.</font><b><font color="#000000">InvertIndex</font></b><font color="#990000">(</font>fCurrColor<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fCurrColor <font color="#990000">=</font><font color="#990000">=</font> <font color="#993399">247</font><font color="#990000">)</font>
        waveColor <font color="#990000">+</font><font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fCurrColor <font color="#990000">=</font><font color="#990000">=</font> <font color="#993399">16</font><font color="#990000">)</font>
        waveColor <font color="#990000">-</font><font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋を現在位置に描画 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>myScreen<font color="#990000">.</font><b><font color="#000000">ColorForIndex</font></b><font color="#990000">(</font>waveColor<font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の色 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fWaveRadius <font color="#990000">=</font><font color="#990000">=</font> kInitialRadius<font color="#990000">)</font> <font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 初期状態 </font></i><i><font color="#9A1900">*/</font></i>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FillEllipse</font></b><font color="#990000">(</font>fWaveOrigin<font color="#990000">,</font> fWaveRadius <font color="#990000">*</font> <font color="#993399">2</font><font color="#990000">,</font> fWaveRadius <font color="#990000">*</font> <font color="#993399">2</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 拡がった状態 </font></i><i><font color="#9A1900">*/</font></i>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">StrokeEllipse</font></b><font color="#990000">(</font>fWaveOrigin<font color="#990000">,</font>
        kInitialRadius <font color="#990000">+</font> fWaveRadius<font color="#990000">,</font> kInitialRadius <font color="#990000">+</font> fWaveRadius<font color="#990000">)</font><font color="#990000">;</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>myScreen<font color="#990000">.</font><b><font color="#000000">ColorForIndex</font></b><font color="#990000">(</font>fCurrColor<font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FillEllipse</font></b><font color="#990000">(</font>fWaveOrigin<font color="#990000">,</font>
        fWaveRadius <font color="#990000">-</font> kInitialRadius<font color="#990000">,</font> fWaveRadius <font color="#990000">-</font> kInitialRadius<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>orgRGBColor<font color="#990000">)</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 元のペンカラーを復元 </font></i><i><font color="#9A1900">*/</font></i>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の半径値を更新 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#990000">(</font>fWaveOrigin<font color="#990000">.</font>x <font color="#990000">*</font> <b><font color="#000000">sqrt</font></b><font color="#990000">(</font><font color="#993399">2.0</font><font color="#990000">)</font><font color="#990000">)</font> <font color="#990000">&lt;</font><font color="#990000">=</font> <font color="#990000">(</font>fWaveRadius <font color="#990000">-</font> kInitialRadius<font color="#990000">)</font><font color="#990000">)</font>
        fWaveRadius <font color="#990000">=</font> kInitialRadius<font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b>
        fWaveRadius <font color="#990000">+</font><font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">UpdateColor </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">!</font><font color="#990000">=</font> NULL<font color="#990000">)</font><font color="#990000">;</font>

    BScreen   <b><font color="#000000">myScreen</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    rgb_color newColor<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の色を算出 </font></i><i><font color="#9A1900">*/</font></i>
    newColor <font color="#990000">=</font> myScreen<font color="#990000">.</font><b><font color="#000000">ColorForIndex</font></b><font color="#990000">(</font>fCurrColor<font color="#990000">-</font><font color="#990000">-</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 使う色がパレットを一周したら最初に戻す </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#990000">(</font>int16<font color="#990000">)</font>fCurrColor <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font>
        fCurrColor <font color="#990000">=</font> <font color="#993399">255</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * WaveViewクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">WaveView </font></b><font color="#990000">(</font>
        BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">BView</font></b><font color="#990000">(</font>frame<font color="#990000">,</font> <font color="#FF0000">"Wave"</font><font color="#990000">,</font> resizeMask<font color="#990000">,</font> B_PULSE_NEEDED<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font>inTimeKeeper <font color="#990000">!</font><font color="#990000">=</font> NULL<font color="#990000">)</font><font color="#990000">;</font>
	
    fTimeKeeper <font color="#990000">=</font> inTimeKeeper<font color="#990000">;</font>
    fCurrColor  <font color="#990000">=</font> <font color="#993399">255</font><font color="#990000">;</font>
    fWaveRadius <font color="#990000">=</font> kInitialRadius<font color="#990000">;</font>
<font color="#FF0000">}</font>

WaveView<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">WaveView </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> do nothing </font></i><i><font color="#9A1900">*/</font></i>  <font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<br/>

最初はアプリケーションクラスです。リスト7.2を見て下さい。ClockworkWaveAppクラスでは、ReadyToRun()メソッドでTimeKeeperオブジェクトを生成し、Quit()メソッドでそれを解放しています。<br/>

<br/>

ClockworkWaveAppクラスのメソッドのうち、MakeClockWin()とMakeWaveWin()、それからMakeMenuBar()については特に説明しません。これらはウィンドウやメニューバーを生成するものですが、前の章の説明で使ったサンプル(TinyApp)と大体同じだからです。ただし、ウィンドウオブジェクトとしてRegularWindowクラスのインスタンスを生成する際、コンストラクタの第五引数に“WINDOW_CLOSED”というメッセージコードを渡していることに着目して下さい。RegularWindowクラスの概要説明でも述べたように、このメッセージコードは、ウィンドウが閉じる時にアプリケーションオブジェクトへ送られるメッセージに使われます。<br/>

<br/>

ClockworkWaveAppクラスはのMessageReceived()メソッドでは、システムで定義されている以外のメッセージ、すなわちClockworkWaveアプリケーションで独自に定義した三つのメッセージを処理します。引数に受け取ったメッセージが自分で定義したものではない場合、親クラスであるBApplicationのメソッドを呼び出して処理を引き継ぎます。これを忘れると、システムで定義されたものを処理することができません。BApplicationクラスの場合ですと、第8章で説明するスクリプティング用のメッセージが処理されなくなってしまいます。<br/>

<br/>

ClockworkWaveAppクラスで定義した三つのメッセージについて、その意味や働きを以下に示します。<br/>

<br/>

 ○WINDOW_CLOSED<br/>

  ウィンドウが閉じた時に、RegularWindowクラスの働きによって送られます。メッセージには、送り主のウィンドウオブジェクトを指すポインタを記録した"sender"(kSender)という名前のデータ項目が含まれており、これを使って送り主を特定します。<br/>

<br/>

 ○SHOW_CLOCK<br/>

  "File"メニューから"Show Clock"項目を選んだ時に送られます。<br/>

<br/>

 ○SHOW_WAVE<br/>

  "File"メニューから"Show Wave"項目を選んだ時に送られます。<br/>

<br/>

上に示した各々のメッセージを処理するメソッド、すなわちメッセージハンドラについて、その働きを以下に示します。<br/>

<br/>

 ○CheckWindow()<br/>

  WINDOW_CLOSEDメッセージに応答し、どのウィンドウが閉じられたかを記録します。ウィンドウが二つとも閉じられた場合は、自身に対して終了要求メッセージを送ってアプリケーションを終了します。<br/>

<br/>

 ○ShowClock()<br/>

  SHOW_CLOCKメッセージに応答し、時刻を表示するウィンドウを開きます。ウィンドウオブジェクトが存在していなければ生成し、そうでない場合はShowWindow()メソッドを呼び出します。<br/>

<br/>

 ○ShowWave()<br/>

  SHOW_WAVEメッセージに応答し、波紋のアニメーションを表示するウィンドウを開きます。ShowClock()と同様。<br/>

<br/>

ShowClock()とShowWave()から呼び出されるShowWindow()メソッドは、ClockworkWaveAppクラスで独自に定義したものです。このメソッドでは、Hide()メソッドによってウィンドウが隠されていればウィンドウオブジェクトに対してShow()メソッドを呼び出し、再表示します。また、最小化して隠されていた場合や、現在フロントウィンドウになっていない場合には、Activate()メソッドを呼び出して表示します。以下に、ここで使っているウィンドウ操作用のAPIを示します。なお、これらのAPIの詳細についてはBeOSのAPIリファレンスを参照して下さい。<br/>

<br/>

 ○IsHidden()<br/>

  ウィンドウオブジェクトがHide()メソッドによって隠されているか、または生成直後でShow()メソッドが呼び出されていない場合、trueを返します。<br/>

<br/>

 ○IsActive()<br/>

  ウィンドウがアクティブであるかどうか、すなわちフロントウィンドウかどうかを返します。<br/>

<br/>

 ○Show()<br/>

  Hide()メソッドによって隠されたウィンドウを、再び画面に表示します。ただし、ウィンドウが生成された後で最初に呼び出された場合は特別で、ウィンドウスレッドを生成してメッセージループの開始処理を行います。<br/>

<br/>

 ○Activate()<br/>

  ウィンドウをフロントウィンドウにするか、またはフロントウィンドウの状態を解除します。引数にtrueを与えると、ウィンドウをフロントウィンドウにします。このメソッドの引数はオプションであり、何も指定しない場合はtrueが与えられます。なお、IsHidden()の戻り値がtrueである状態では、このメソッドを呼び出してもフロントウィンドウにすることはできません。<br/>

<br/>

IsHidden()やIsActive()メソッドを呼び出す場合、ウィンドウオブジェクトがアプリケーションのメインスレッドとは独立したスレッドによって動作しているため、ウィンドウにロックをかけないと正しい結果が得られない場合があります。リスト7.2では、BAutolockクラスを利用してウィンドウにロックをかけていることに注意して下さい。<br/>

<br/>

アプリケーションクラスの次は、ウィンドウクラスです。リスト7.3と7.4を見て下さい。リストの内容を見ると分かるように、ここで使っているRegularWindowクラスは、前の章の説明で使ったSingleWindowクラス(リスト6.3, 6.4)と大体同じです。違うのは、ウィンドウが閉じた時に送るメッセージのコードを記憶しておく“fQuitMsg”というデータメンバを追加したのと、またメニューバーとビューオブジェクトを受け取るバージョンのInitContent()メソッドを追加したことです。ただし、追加されたバージョンのInitContent()メソッドも、前の章のSmartWindowクラス(リスト6.15,6.16)で説明済みです。したがって、RegularWindowクラスについてはこれ以上説明しません。<br/>

<br/>

アプリケーションクラスとウィンドウクラスの説明が終わったので、次はメインとなるビュークラスを説明します。リスト7.5と7.6に示したClockViewクラスのソース、およびリスト7.7と7.8に示したWaveViewクラスのソースを見て下さい。これらのクラスのメソッドのうち、主なものの働きを以下に示します。<br/>

<br/>

 (1)ClockViewクラスの主要メソッド<br/>

 ○AttachedToWindow()<br/>

  TimeKeeperオブジェクトに対し、1秒おきに時刻更新イベントを起こすように登録します。この結果、以後は1秒に1回“UPDATE_TIME”メッセージが送られてくるようになります。また、UpdateTime()メソッドを呼び出し、画面に表示されたら直ちに現在時刻を表示できるようにします。<br/>

<br/>

 ○DeatchedFromWindow()<br/>

  TimeKeeperオブジェクトから、登録したイベントを削除します。<br/>

<br/>

 ○Draw()<br/>

  DrawString()メソッドを使って、現在時刻をデジタル表示します。時刻表示に使う文字列のフォントサイズを大きなものにするために、SetFontSize()メソッドでフォントサイズを変更しています。<br/>

<br/>

 ○MessageReceived()<br/>

  UPDATE_TIMEメッセージを受け取ったら、UpdateTime()メソッドを呼び出します。それ以外の場合は、BViewクラスのメソッドを呼び出して処理を引き継ぎます。<br/>

<br/>

 ○UpdateTime()<br/>

  localtime()を使って現在時刻を取得し、データメンバにセットします。その後、Draw()メソッドを呼び出して再描画を行います。<br/>

<br/>

 (2)WaveViewクラスの主要メソッド<br/>

 ○AttachedToWindow()<br/>

  TimeKeeperオブジェクトに対し、4秒おきに色の更新イベントを起こすように登録します。この結果、以後は4秒に1回“UPDATE_COLOR”メッセージが送られてくるようになります。また、水面の色の初期値を設定するためにUpdateColor()メソッドを呼び出します。その他、円形の波紋を表示する際の原点座標の算出と、Pulse()メソッドの呼び出しレート設定を行っています。<br/>

<br/>

 ○DeatchedFromWindow()<br/>

  TimeKeeperオブジェクトから、登録したイベントを削除します。<br/>

<br/>

 ○MessageReceived()<br/>

  UPDATE_COLORメッセージを受け取ったら、UpdateColor()メソッドを呼び出します。それ以外の場合は、BViewクラスのメソッドを呼び出して処理を引き継ぎます。<br/>

<br/>

 ○Pulse()<br/>

  波紋の表示を更新します。波紋は水面、つまりウィンドウの中心から外側に向けて拡がっていきます。リスト7.8では、前回の呼び出しよりも1ポイント(注7-1)だけ大きい円弧を描いた後、同じく前回よりも1ポイント大きい円を水面の色で塗りつぶしています。この結果、一定の幅を保った波紋が、Pulse()の呼び出しごとに1ポイントずつ半径を拡げながら水面を伝わっていくのです。この波紋描画アルゴリズムは本章の説明の中心ではありませんから、これ以上の説明は省略します。詳細はリスト7.8を参照して下さい。<br/>

<br/>

 ○UpdateColor()<br/>

  水面の表示に使う色を変更します。WaveViewでは256色表示を行い、0番目の色から255番目の色まで、UpdateColor()が呼ばれるたびに一つずつ色を変えていきます。また、波紋の色は水面の色を逆転させたものにしているのですが、そのためにBScreenクラスのInvertIndex()メソッドを利用しています。<br/>

<br/>

ここで、WaveViewクラスが利用しているBScreenクラスについて簡単に説明しておきましょう。このクラスは、スクリーンのサイズや色深度など、モニタやビデオカードの特性情報にアクセスするためのもので、Interface Kitで提供されています。リスト7.8では、256色の中からインデックスで指定したものを取得するColorForIndex()、および逆転色のインデックスを取得するInvertIndex()メソッドを使っています。なお、BeOSは1998年2月の時点でマルチスクリーンに対応していませんが、BScreenクラスのインタフェースはマルチスクリーンを意識したものになっています。スクリーンの指定はBScreenのコンストラクタに渡す引数を使って行い、スクリーンのIDかまたはウィンドウによって指定します。何も引数を与えない場合は、メインスクリーンのIDを指定したことになるのですが、リスト7.8では念のためにウィンドウを使ってスクリーンを指定しています。詳細はAPIリファレンスを参照して下さい。<br/>

<br/>

<span id="annotate"><dl><dt>(注)7-1</dt><dd>BeOSでは、描画システムの座標単位は1/72インチになっており、他のOSの場合と変わりません。ただし、APIが扱う座標値の型がintではなくfloatなのが特徴的です。</dd></dl></span>
<br/>

<br/>
<a name="7.1.3"></a>
<h3>7.1.3&nbsp;&nbsp;Pulse()のどこがいけないの</h3>
ClockworkWaveアプリケーションの改良バージョンに話を進める前に、WaveViewクラスで再定義しているPulse()メソッドの話をしておくことにします。このメソッドは一定の間隔で呼び出されるフック関数で、BViewクラスのコンストラクタに渡す第四引数のフラグを使って呼び出しを制御します。つまり、フラグの値に“B_PULSE_NEEDED”を含めると呼び出しが行われ、含めない場合は呼び出しが行われません。リスト7.8でWaveViewクラスのコンストラクタを見ると、たしかにBViewクラスのコンストラクタの第四引数に“B_PULSE_NEEDED”を渡しています。<br/>

<br/>

Pulse()メソッドが呼び出される間隔は、BWindowクラスのSetPulseRate()を使って指定します。このメソッドの引数には、呼び出し間隔をマイクロ秒単位で指定した値を渡します。つまり、引数に1000*1000を渡せば1秒ごとにPulse()メソッドが呼び出されるのです。あれ?ちょっと待って下さい。SetPulseRate()で指定した間隔でPulse()メソッドが繰り返し呼び出されるのなら、わざわざTimeKeeperなんていうクラスを作らずに、全部Pulse()メソッドを利用して済ませれば良かったのではないでしょうか。<br/>

<br/>

そうしなかった理由は、実はWaveViewクラスにあります。WaveViewは波紋のアニメーションを表示しますが、その波紋の色は4秒ごとに変化します。つまり、アニメーション表示のためのタイミング処理の他に、波紋の色を変えるという、別のタイミング処理を行なう必要があるのです。しかし、Pulse()メソッドだけでは、複数のタイミング処理を同時に扱うことはできません。ビュークラスのPulse()メソッドは、そのビューオブジェクトが所属するウィンドウオブジェクトに対しSetPulseRate()メソッドを呼び出して設定した、一定の繰り返し間隔で呼び出されるだけだからです。つまり、タイミング処理の設定はウィンドウごとに一種類しかできないのです。これが、TimeKeeperクラスを導入した最大の理由です。<br/>

<br/>

Pulse()メソッドは、一定間隔で行う繰り返し処理向けであり、指定した時刻に一回だけイベントを起こしたいという場合には利用できません。結局、Pulse()メソッドが適しているのは、WaveViewが行うアニメーション表示のように、比較的簡単な繰り返し処理なのです。繰り返しの間隔に正確さを要求される場合や、また時刻を定めて行う処理には使えません。逆に、単純な繰り返し処理であれば、とても簡単に利用できます。アニメーション表示とは少し違いますが、プログレスバーの表示を行う場合に利用すると、表示の更新処理がとても簡単になるでしょう。<br/>

<br/>

7.3節で見るように、TimeKeeperクラスの方は汎用のイベントスケジューラであり、Pulse()メソッドには適していない処理にも利用することができます。<br/>

<br/>

<br/>
<a name="7.2"></a>
<h2>7.2&nbsp;&nbsp;ちらつきを無くすには</h2>
ClockworkWaveアプリケーションの内部を理解したら、次は改良バージョンに進みましょう。どこを改良したのか分からない人は、7.1.1に戻って実際の動きを確認して下さい。二つのバージョンを動かして比べてみれば、その違いが分かるはずです。<br/>

<br/>

<br/>
<a name="7.2.1"></a>
<h3>7.2.1&nbsp;&nbsp;改善目標</h3>
念のために書いておくと、最初のバージョンには以下の欠陥があります。<br/>

<br/>

 ・時刻表示を行うウィンドウ("Clock Window")で、表示を更新するたびに画面がちらつく。<br/>

<br/>

 ・波紋のアニメーション表示を行うウィンドウ("Wave Window")は、他のウィンドウを上に置いて隠したあと、再描画させると隠れていた部分が白くなってしまう。<br/>

<br/>

"Clock Window"で画面がちらつくのが分からない場合は、ウィンドウをリサイズして拡げてみて下さい。ちらつきが大きくなるので、分かりやすくなります。また、WaveWindowでの再描画の問題については、その様子を撮ったスクリーンショットを図7.4に示します。<br/>

<br/>

<div id="imagebox">
<img src="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/img/7.04.jpg" alt="図 再描画されずに一部が白くなったWave Windowの画面"/><div>図[7.4]  再描画されずに一部が白くなったWave Windowの画面</div>
</div>

<br/>

これから説明する改良バージョンでは、上に挙げた二つの欠陥を改善します。改良バージョンのソースコードを見る前に、どのようにして改善するのかを説明することにします。その説明を読めば、BeOSのAPIが提供するクラスの一つを利用するだけで、二つの欠陥を克服できることが分かるでしょう。<br/>

<br/>

<br/>
<a name="7.2.2"></a>
<h3>7.2.2&nbsp;&nbsp;オフスクリーン描画とBBitmap</h3>
まず、"Clock Winodw"で画面がちらつく原因を説明します。ちらつきが起きるのは、現在時刻、つまりウィンドウの表示内容を更新する際に、描画処理の途中経過が見えてしまうからなのです。"Clock Window"ではグレーの背景に黒で現在時刻を表示しますが、この表示を更新する時は、いったん背景色のグレーで塗りつぶし、それから時刻を示す黒い文字列を描き直します(注7-2)。背景色で塗りつぶすのは、単純に文字列を重ね描きしたのでは更新前の文字列が残ってしまうからです。つまり、一度背景色を使って文字列を消し、それから文字列を描き直します。そして、この様子がそのまま見えるために、ちらつきが起きるのです。<br/>

<br/>

では、どうすればいいのでしょうか?答えは簡単。途中経過を見せなければよいのです。もしあなたが料理番組のファンなら、ヒントはそこに転がっています。料理番組では、シチューの作り方を説明するのに、テレビカメラの前で5時間煮込んで見せたりはしません。下ごしらえが済んだ材料を鍋に入れて火にかけたら、次は、前もって煮込んでおいた別のシチュー鍋を取り出し、それから説明を続けるでしょう。これと同じことをすればよいのです。<br/>

<br/>

そう、目に見えるスクリーンとは別の場所で描画処理を済ませてしまい、それから結果だけをスクリーンに送れば、途中経過は見えません。これは「オフスクリーン描画」と呼ばれるやり方で、ちらつきを無くすために使われる一般的なものです。BeOSでは専用のAPIが提供されており、これを使えば、オフスクリーン描画を簡単に行うことができます。<br/>

<br/>

BeOSでオフスクリーン描画を行うには、BBitmapクラスとBViewクラスを利用します。BBitmapは、オフスクリーン描画に使うビットマップデータ領域(一般的に、これは「オフスクリーンバッファ」と呼ばれます)を内部に持っており、まずその中に描画内容を書き込んで保存します。次に、BViewクラスのDrawBitmap()メソッドを呼び出してBBitmapオブジェクトを渡せば、それで終わりです。あとは、BViewクラスの働きによってオフスクリーンバッファの内容がスクリーンに転送されます。図7.5に、BBitmapクラスを使ったオフスクリーン描画処理の流れを示します。<br/>

<br/>

<div id="imagebox">
<img src="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/img/7.05.jpg" alt="図 BBitmapによるオフスクリーン描画の流れ"/><div>図[7.5]  BBitmapによるオフスクリーン描画の流れ</div>
</div>

<br/>

さて、BBitmapクラスを利用してオフスクリーン描画を行えば、"Clock Window"で画面がちらつくのを直せることが分かりました。次は、"Wave Window"で表示内容が消えてしまう問題です。"Wave Window"を他のウィンドウで隠した時に表示内容が消えてしまうのは、一回の描画処理では表示内容の一部しか描画していないせいです。<br/>

<br/>

リスト7.8で見たように、WaveViewクラスでは画面全体を描き直すのではなく、一部のみを描き直し、それを繰り返すことで滑らかなアニメーション表示を行っています。しかし、それだけでは再描画の時に問題が起きてしまうというわけです。どうすれば良いのでしょうか?「"Clock View"と同じように、一度オフスクリーンに描画してからスクリーンに転送するよう変更する。」惜しい、もう一工夫です。せっかくオフスクリーン描画を使わずに滑らかなアニメーション表示ができていたのですから、それを活かしたいと思います。<br/>

<br/>

ここでは、表示内容のバックアップとしてオフスクリーンバッファを利用します。つまり、スクリーンに描画するのと同時に、同じ内容をオフスクリーンにも描画しておき、再描画の時にそれを利用するのです。実際の処理手順については、サンプルを使って説明します。<br/>

<br/>

<span id="annotate"><dl><dt>(注)7-2</dt><dd>再描画を行う際、直接Draw()メソッドを呼び出すのではなく、Invalidate()メソッドを使って間接的にDraw()メソッドを呼び出させることもできます。その場合、Invalidate()メソッドで指定された再描画領域がウィンドウオブジェクトの働きによってクリアされます。このため、Invalidate()メソッドを使って再描画を行うと、文字列を描画する前に背景の塗りつぶしを行う必要がなくなります。ただし、画面のちらつきが起こるのは変わりません。</dd></dl></span>
<br/>

<br/>
<a name="7.2.3"></a>
<h3>7.2.3&nbsp;&nbsp;改良版ClockworkWave</h3>
リスト7.9～7.12に、ClockworkWaveアプリケーションの改良版のソースを示します。なお、アプリケーションクラスやウィンドウクラスについては変更を加える必要がありませんでしたので、ここでは省略しています。必要であればリスト7.1～7.4を参照して下さい。<br/>

<br/>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.9] ClockView.hの内容(改訂版)</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _CLOCK_VIEW_H_
<b><font color="#000080">#define</font></b> _CLOCK_VIEW_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimedView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;time.h&gt;</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ClockViewクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> ClockView <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> TimedView <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">ClockView</font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">~</font><b><font color="#000000">ClockView</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 描画処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">AttachedToWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">DetachedFromWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">Draw</font></b><font color="#990000">(</font>BRect updateRect<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メッセージ処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">UpdateTime</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    tm       fTime<font color="#990000">;</font>       <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 現在時刻 </font></i><i><font color="#9A1900">*/</font></i>
    BBitmap<font color="#990000">*</font> fOffscreen<font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーン描画用 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _CLOCK_VIEW_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.10] ClockView.cpの内容(改訂版)</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"ClockView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"KGUtility/kgDebug.h"</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Bitmap.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;stdio.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージのコード </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">enum</font></b> <font color="#FF0000">{</font>
    UPDATE_TIME	<font color="#990000">=</font> <font color="#FF0000">'uptm'</font>
<font color="#FF0000">}</font><font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> ClockViewクラスの非公開メソッド </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 描画処理; ClockView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AttachedToWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t     sts<font color="#990000">;</font>
    ScheduleInfo theSchedule<font color="#990000">;</font>
    BView<font color="#990000">*</font>       theOffView<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 時刻更新スケジュールを登録 </font></i><i><font color="#9A1900">*/</font></i>
    theSchedule<font color="#990000">.</font>client    <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>message   <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>UPDATE_TIME<font color="#990000">)</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>period    <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>first_time <font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">real_time_clock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    sts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddSchedule</font></b><font color="#990000">(</font>theSchedule<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーン描画用のBBitmapとBViewを生成 </font></i><i><font color="#9A1900">*/</font></i>
    fOffscreen <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BBitmap</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">,</font> B_COLOR_8_BIT<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">)</font><font color="#990000">;</font>
    theOffView <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BView</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">,</font> <font color="#FF0000">""</font><font color="#990000">,</font> B_FOLLOW_ALL_SIDES<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    theOffView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetViewColor</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ViewColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddChild</font></b><font color="#990000">(</font>theOffView<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 現在の時刻を取得 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateTime</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"ClockView::AttachedToWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">DetachedFromWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t	sts<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 時刻更新スケジュールを削除 </font></i><i><font color="#9A1900">*/</font></i>
    sts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RmvSchedule</font></b><font color="#990000">(</font>UPDATE_TIME<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 不要なBBitmapオブジェクトを解放 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">delete</font></b> fOffscreen<font color="#990000">;</font>
    fOffscreen <font color="#990000">=</font> NULL<font color="#990000">;</font>

    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"ClockView::DetachedFromWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Draw </font></b><font color="#990000">(</font>BRect updateRect<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーンからVRAMにコピー </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">DrawBitmap</font></b><font color="#990000">(</font>fOffscreen<font color="#990000">,</font> updateRect<font color="#990000">,</font> updateRect<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メッセージ処理; ClockView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived </font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">case</font></b> UPDATE_TIME<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateTime</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>	<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
        BView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">UpdateTime </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    time_t    curTime <font color="#990000">=</font> <b><font color="#000000">time</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">char</font>      timeStr<font color="#990000">[</font><font color="#993399">64</font><font color="#990000">]</font><font color="#990000">;</font>
    BView<font color="#990000">*</font>    offView<font color="#990000">;</font>
    rgb_color orgColor<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 現在時刻情報を更新 </font></i><i><font color="#9A1900">*/</font></i>
    fTime <font color="#990000">=</font> <font color="#990000">*</font><font color="#990000">(</font><b><font color="#000000">localtime</font></b><font color="#990000">(</font><font color="#990000">&amp;</font>curTime<font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">sprintf</font></b><font color="#990000">(</font>timeStr<font color="#990000">,</font> <font color="#FF0000">"%02d:%02d:%02d"</font><font color="#990000">,</font>
        fTime<font color="#990000">.</font>tm_hour<font color="#990000">,</font> fTime<font color="#990000">.</font>tm_min<font color="#990000">,</font> fTime<font color="#990000">.</font>tm_sec<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> BBitmapをロック </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Lock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーンに時刻を描画 </font></i><i><font color="#9A1900">*/</font></i>
    offView  <font color="#990000">=</font> fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ChildAt</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    orgColor <font color="#990000">=</font> offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">HighColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ViewColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FillRect</font></b><font color="#990000">(</font>offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>orgColor<font color="#990000">)</font><font color="#990000">;</font>
    offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetFontSize</font></b><font color="#990000">(</font><font color="#993399">30</font><font color="#990000">)</font><font color="#990000">;</font>
    offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">DrawString</font></b><font color="#990000">(</font>timeStr<font color="#990000">,</font> <b><font color="#000000">BPoint</font></b><font color="#990000">(</font><font color="#993399">18</font><font color="#990000">,</font> <font color="#993399">40</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 更新すべき領域を再描画 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Draw</font></b><font color="#990000">(</font>offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> ロックを解除 </font></i><i><font color="#9A1900">*/</font></i>
    fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Unlock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * ClockViewクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
ClockView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ClockView </font></b><font color="#990000">(</font>
        BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">TimedView</font></b><font color="#990000">(</font>frame<font color="#990000">,</font> <font color="#FF0000">"ClockView"</font><font color="#990000">,</font> resizeMask<font color="#990000">,</font> B_WILL_DRAW<font color="#990000">,</font> inTimeKeeper<font color="#990000">)</font>
<font color="#FF0000">{</font>
    fOffscreen <font color="#990000">=</font> NULL<font color="#990000">;</font>
<font color="#FF0000">}</font>

ClockView<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">ClockView </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">delete</font></b> fOffscreen<font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.11] WaveView.hの内容(改訂版)</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _WAVE_VIEW_H_
<b><font color="#000080">#define</font></b> _WAVE_VIEW_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimedView.h"</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * WaveViewクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> WaveView <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> TimedView <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">WaveView</font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">~</font><b><font color="#000000">WaveView</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 描画処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">AttachedToWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">DetachedFromWindow</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">Draw</font></b><font color="#990000">(</font>BRect updateRect<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">DrawWave</font></b><font color="#990000">(</font>BView<font color="#990000">*</font> inTargetView<font color="#990000">,</font>
        rgb_color waveColor<font color="#990000">,</font> rgb_color backColor<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メッセージ処理</font></i>
    <font color="#009900">void</font>	<b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">Pulse</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#009900">void</font>	<b><font color="#000000">UpdateColor</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    uint8    fCurrColor<font color="#990000">;</font>		<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 水面の色 </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#009900">float</font>    fWaveRadius<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の半径 </font></i><i><font color="#9A1900">*/</font></i>
    BPoint   fWaveOrigin<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の中心 </font></i><i><font color="#9A1900">*/</font></i>
    BBitmap<font color="#990000">*</font> fOffscreen<font color="#990000">;</font>		<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーン描画用 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _WAVE_VIEW_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.12] WaveView.cpの内容(改訂版)</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"WaveView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"KGUtility/kgDebug.h"</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Bitmap.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/Screen.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Debug.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージのコード </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">enum</font></b> <font color="#FF0000">{</font>
    UPDATE_COLOR	<font color="#990000">=</font> <font color="#FF0000">'upcl'</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> その他の定数 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">const</font></b> <font color="#009900">float</font>	kInitialRadius	<font color="#990000">=</font> <font color="#993399">10</font><font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋半径の初期値 </font></i><i><font color="#9A1900">*/</font></i>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> WaveViewクラスの非公開メソッド </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 描画処理; WaveView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AttachedToWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t     sts<font color="#990000">;</font>
    ScheduleInfo theSchedule<font color="#990000">;</font>
    BRect        myBounds <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Bounds</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    BView<font color="#990000">*</font>       theOffView<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 表示色更新スケジュールを登録 </font></i><i><font color="#9A1900">*/</font></i>
    theSchedule<font color="#990000">.</font>client     <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>message    <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BMessage</font></b><font color="#990000">(</font>UPDATE_COLOR<font color="#990000">)</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>period     <font color="#990000">=</font> <font color="#993399">4</font><font color="#990000">;</font>
    theSchedule<font color="#990000">.</font>first_time <font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">real_time_clock</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">+</font> <font color="#993399">4</font><font color="#990000">;</font>
    sts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddSchedule</font></b><font color="#990000">(</font>theSchedule<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーン描画用のBBitmapとBViewを生成 </font></i><i><font color="#9A1900">*/</font></i>
    fOffscreen <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BBitmap</font></b><font color="#990000">(</font>myBounds<font color="#990000">,</font> B_COLOR_8_BIT<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">)</font><font color="#990000">;</font>
    theOffView <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BView</font></b><font color="#990000">(</font>myBounds<font color="#990000">,</font> <font color="#FF0000">""</font><font color="#990000">,</font> B_FOLLOW_ALL_SIDES<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddChild</font></b><font color="#990000">(</font>theOffView<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 水面の色の初期値を設定 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetPulseRate</font></b><font color="#990000">(</font><font color="#993399">100</font> <font color="#990000">*</font> <font color="#993399">1000</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の原点座標を決定 </font></i><i><font color="#9A1900">*/</font></i>
    fWaveOrigin<font color="#990000">.</font>x <font color="#990000">=</font> myBounds<font color="#990000">.</font><b><font color="#000000">Width</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">2</font><font color="#990000">;</font>
    fWaveOrigin<font color="#990000">.</font>y <font color="#990000">=</font> myBounds<font color="#990000">.</font><b><font color="#000000">Height</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">2</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"WaveView::AttachedToWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">DetachedFromWindow </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t	sts<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 表示色更新スケジュールを削除 </font></i><i><font color="#9A1900">*/</font></i>
    sts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RmvSchedule</font></b><font color="#990000">(</font>UPDATE_COLOR<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 不要なBBitmapを解放 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">delete</font></b> fOffscreen<font color="#990000">;</font>
    fOffscreen <font color="#990000">=</font> NULL<font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"WaveView::DetachedFromWindow"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Draw </font></b><font color="#990000">(</font>BRect updateRect<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーンからVRAMに転送 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">DrawBitmap</font></b><font color="#990000">(</font>fOffscreen<font color="#990000">,</font> updateRect<font color="#990000">,</font> updateRect<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">DrawWave </font></b><font color="#990000">(</font>
	BView<font color="#990000">*</font> inTargetView<font color="#990000">,</font> rgb_color waveColor<font color="#990000">,</font> rgb_color backColor<font color="#990000">)</font>
<font color="#FF0000">{</font>
    rgb_color	orgRGBColor <font color="#990000">=</font> inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">HighColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋を現在位置に描画 </font></i><i><font color="#9A1900">*/</font></i>
    inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>waveColor<font color="#990000">)</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の色 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fWaveRadius <font color="#990000">=</font><font color="#990000">=</font> kInitialRadius<font color="#990000">)</font> <font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 初期状態 </font></i><i><font color="#9A1900">*/</font></i>
        inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FillEllipse</font></b><font color="#990000">(</font>
            fWaveOrigin<font color="#990000">,</font> fWaveRadius <font color="#990000">*</font> <font color="#993399">2</font><font color="#990000">,</font> fWaveRadius <font color="#990000">*</font> <font color="#993399">2</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 拡がった状態 </font></i><i><font color="#9A1900">*/</font></i>
        inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">StrokeEllipse</font></b><font color="#990000">(</font>fWaveOrigin<font color="#990000">,</font>
            kInitialRadius <font color="#990000">+</font> fWaveRadius<font color="#990000">,</font> kInitialRadius <font color="#990000">+</font> fWaveRadius<font color="#990000">)</font><font color="#990000">;</font>
        inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>backColor<font color="#990000">)</font><font color="#990000">;</font>
        inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FillEllipse</font></b><font color="#990000">(</font>fWaveOrigin<font color="#990000">,</font>
            fWaveRadius <font color="#990000">-</font> kInitialRadius<font color="#990000">,</font> fWaveRadius <font color="#990000">-</font> kInitialRadius<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    inTargetView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SetHighColor</font></b><font color="#990000">(</font>orgRGBColor<font color="#990000">)</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 元のペンカラーを復元 </font></i><i><font color="#9A1900">*/</font></i>

    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メッセージ処理; WaveView</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived </font></b><font color="#990000">(</font>BMessage<font color="#990000">*</font> message<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">case</font></b> UPDATE_COLOR<font color="#990000">:</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">UpdateColor</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>	<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
        BView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">MessageReceived</font></b><font color="#990000">(</font>message<font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Pulse </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BView<font color="#990000">*</font>    offView<font color="#990000">;</font>
    uint8     waveColor<font color="#990000">;</font>
    BScreen   <b><font color="#000000">myScreen</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    rgb_color waveRGBColor<font color="#990000">,</font> backRGBColor<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の色を決定 </font></i><i><font color="#9A1900">*/</font></i>	
    waveColor <font color="#990000">=</font> myScreen<font color="#990000">.</font><b><font color="#000000">InvertIndex</font></b><font color="#990000">(</font>fCurrColor<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fCurrColor <font color="#990000">=</font><font color="#990000">=</font> <font color="#993399">247</font><font color="#990000">)</font>
        waveColor <font color="#990000">+</font><font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fCurrColor <font color="#990000">=</font><font color="#990000">=</font> <font color="#993399">16</font><font color="#990000">)</font>
        waveColor <font color="#990000">-</font><font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">;</font>
    waveRGBColor <font color="#990000">=</font> myScreen<font color="#990000">.</font><b><font color="#000000">ColorForIndex</font></b><font color="#990000">(</font>waveColor<font color="#990000">)</font><font color="#990000">;</font>
    backRGBColor <font color="#990000">=</font> myScreen<font color="#990000">.</font><b><font color="#000000">ColorForIndex</font></b><font color="#990000">(</font>fCurrColor<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋を描画 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">DrawWave</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">,</font> waveRGBColor<font color="#990000">,</font> backRGBColor<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> オフスクリーンにも描画 </font></i><i><font color="#9A1900">*/</font></i>
    fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Lock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    offView <font color="#990000">=</font> fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ChildAt</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">DrawWave</font></b><font color="#990000">(</font>offView<font color="#990000">,</font> waveRGBColor<font color="#990000">,</font> backRGBColor<font color="#990000">)</font><font color="#990000">;</font>
    offView<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Flush</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> !! </font></i><i><font color="#9A1900">*/</font></i>
    fOffscreen<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Unlock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の半径値を更新 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#990000">(</font>fWaveOrigin<font color="#990000">.</font>x <font color="#990000">*</font> <b><font color="#000000">sqrt</font></b><font color="#990000">(</font><font color="#993399">2.0</font><font color="#990000">)</font><font color="#990000">)</font> <font color="#990000">&lt;</font><font color="#990000">=</font> <font color="#990000">(</font>fWaveRadius <font color="#990000">-</font> kInitialRadius<font color="#990000">)</font><font color="#990000">)</font>
        fWaveRadius <font color="#990000">=</font> kInitialRadius<font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b>
        fWaveRadius <font color="#990000">+</font><font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 注意:ここでは、オフスクリーン描画を行った後にオフスクリーンウィン</font></i>
<i><font color="#9A1900"> *  ドウに対してFlush()メソッドを呼び出している。この呼び出しを行わ</font></i>
<i><font color="#9A1900"> *  ないと、描画内容がオフスクリーンウィンドウへ反映されないうちに</font></i>
<i><font color="#9A1900"> *  Draw()メソッドによるオンスクリーンへの転送が行われ、正常に描画</font></i>
<i><font color="#9A1900"> *  されない場合がある。</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font>

<font color="#009900">void</font>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">UpdateColor </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font> <font color="#990000">!</font><font color="#990000">=</font> NULL<font color="#990000">)</font><font color="#990000">;</font>

    BScreen   <b><font color="#000000">myScreen</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Window</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>
    rgb_color newColor<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 波紋の色を算出 </font></i><i><font color="#9A1900">*/</font></i>
    newColor <font color="#990000">=</font> myScreen<font color="#990000">.</font><b><font color="#000000">ColorForIndex</font></b><font color="#990000">(</font>fCurrColor<font color="#990000">-</font><font color="#990000">-</font><font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 使う色がパレットを一周したら最初に戻す </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#990000">(</font>int16<font color="#990000">)</font>fCurrColor <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font>
        fCurrColor <font color="#990000">=</font> <font color="#993399">255</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * WaveViewクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
WaveView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">WaveView </font></b><font color="#990000">(</font>
        BRect frame<font color="#990000">,</font> uint32 resizeMask<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">TimedView</font></b><font color="#990000">(</font>frame<font color="#990000">,</font> <font color="#FF0000">"Wave"</font><font color="#990000">,</font> resizeMask<font color="#990000">,</font>
        B_PULSE_NEEDED<font color="#990000">|</font>B_WILL_DRAW<font color="#990000">,</font> inTimeKeeper<font color="#990000">)</font>
<font color="#FF0000">{</font>
    fCurrColor  <font color="#990000">=</font> <font color="#993399">255</font><font color="#990000">;</font>
    fWaveRadius <font color="#990000">=</font> kInitialRadius<font color="#990000">;</font>
    fOffscreen  <font color="#990000">=</font> NULL<font color="#990000">;</font>
<font color="#FF0000">}</font>

WaveView<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">WaveView </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">delete</font></b> fOffscreen<font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<br/>

リスト7.9と7.11を見ると分かるように、改良版ではビュークラスのデータメンバとしてBBitmapオブジェクトを追加し、また“TimedView”というクラスを継承するようにしています。TimedViewクラスは、最初のバージョンのClockViewクラスとWaveViewクラスが重複して持っていた機能を一つにまとめたものです。リスト7.13と7.14にそれを示しますが、TimeKeeperオブジェクトにタイミング処理を登録するメソッド、および登録したタイミング処理を削除するメソッドを持っています。<br/>

<br/>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.13] TimedView.hの内容</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _TIMED_VIEW_H_
<b><font color="#000080">#define</font></b> _TIMED_VIEW_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;interface/View.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 関連クラス・構造体 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b>  TimeKeeper<font color="#990000">;</font>
<b><font color="#0000FF">struct</font></b> ScheduleInfo<font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * TimedViewクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> TimedView <font color="#990000">:</font> <b><font color="#0000FF">public</font></b> BView <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">TimedView</font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*</font> title<font color="#990000">,</font>
        uint32 resizedMask<font color="#990000">,</font> uint32 flags<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">virtual</font></b> <font color="#990000">~</font><b><font color="#000000">TimedView</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

<b><font color="#0000FF">protected</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> スケジュール情報の管理</font></i>
    status_t	<b><font color="#000000">AddSchedule</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> ScheduleInfo<font color="#990000">&amp;</font> inSchedule<font color="#990000">)</font><font color="#990000">;</font>
    status_t	<b><font color="#000000">RmvSchedule</font></b><font color="#990000">(</font>uint32 theCode<font color="#990000">)</font><font color="#990000">;</font>

<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    TimeKeeper<font color="#990000">*</font>	fTimeKeeper<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> タイミング動作用のスケジューラ </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _TIMED_VIEW_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.14] TimedView.cpの内容</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"TimedView.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * TimedViewクラスの非公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
status_t
TimedView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AddSchedule </font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> ScheduleInfo<font color="#990000">&amp;</font> inSchedule<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">InsertSchedule</font></b><font color="#990000">(</font>inSchedule<font color="#990000">)</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

status_t
TimedView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">RmvSchedule </font></b><font color="#990000">(</font>uint32 theCode<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> fTimeKeeper<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveSchedule</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">,</font> theCode<font color="#990000">)</font><font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * TimedViewクラスの公開メソッド</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
TimedView<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">TimedView </font></b><font color="#990000">(</font>BRect frame<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*</font> title<font color="#990000">,</font>
        uint32 resizeMask<font color="#990000">,</font> uint32 flags<font color="#990000">,</font> TimeKeeper<font color="#990000">*</font> inTimeKeeper<font color="#990000">)</font>
    <font color="#990000">:</font> <b><font color="#000000">BView</font></b><font color="#990000">(</font>frame<font color="#990000">,</font> title<font color="#990000">,</font> resizeMask<font color="#990000">,</font> flags<font color="#990000">)</font>
<font color="#FF0000">{</font>
    fTimeKeeper <font color="#990000">=</font> inTimeKeeper<font color="#990000">;</font>
<font color="#FF0000">}</font>

TimedView<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">TimedView </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> do nothing </font></i><i><font color="#9A1900">*/</font></i>  <font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<br/>

では、BBitmapクラスの使い方を説明します。リスト7.10を見て下さい。リスト7.10に示した改良版ClockViewクラスのソースでは、まずAttachedToWindow()メソッドでBBitmapオブジェクトを生成しています。また、BViewオブジェクトも一緒に生成し、BBitmapオブジェクトに対してAddChild()メソッドを呼び出して貼りつけています。これは、オフスクリーン描画を行う場合もBViewクラスのメソッドを利用するからです。<br/>

<br/>

BBitmapオブジェクトを生成する際に、コンストラクタへ三つの引数を渡していますが、これについて簡単に説明しておきます。以下は、BBitmapクラスのコンストラクタが受け取る引数の説明です。<br/>

<br/>

 ○第一引数(BRect)<br/>

  ビットマップデータ領域、つまりビットマップの大きさと、原点座標を指定します。<br/>

<br/>

 ○第二引数(color_space)<br/>

  ビットマップの色深度を指定します。指定できる色深度の詳細は、APIのリファレンスを参照して下さい。<br/>

<br/>

 ○第三引数(bool)<br/>

  オフスクリーン用のウィンドウを内部で生成し、BViewオブジェクトを貼りつけ可能にするかどうかを指定します。<br/>

<br/>

 ○第四引数(bool)<br/>

  ビットマップデータ用のメモリを、どのように確保するかを指定します。なお、この引数はオプションなので、リスト7.10では何も指定していません。この引数の詳細については、APIのリファレンスを参照して下さい。<br/>

<br/>

リスト7.10では、色深度として“B_COLOR_8_BIT”、つまり256色表示を行うのに十分な8ビットカラーを指定しています。また、第三引数にtrueを渡し、オフスクリーン用のウィンドウオブジェクトが生成されるようにしています。この引数にfalseを渡した場合、オフスクリーン描画を行うことはできません。BBitmapクラスは、オフスクリーン描画を行う以外に単純なビットマップデータだけを持たせて利用することもできるのですが(注7-3)、どちらの目的で使うのかを第三引数で指定します。<br/>

<br/>

BBitmapオブジェクトを生成したら、次はオフスクリーン描画を行い、それからスクリーンに転送して終わりです。7.2.2の図7.5に示した流れを、リスト7.10で確認しましょう。リスト7.10では、ClockViewクラスのUpdateTime()メソッドでオフスクリーン描画を行っています。スクリーンに直接描画する場合と違い、ウィンドウオブジェクトをロックする代わりにBBitmapオブジェクトをロックしていることに注目して下さい。描画処理そのものは、BBitmapオブジェクトに貼りつけたBViewオブジェクトの描画メソッドを呼び出して行いますので、スクリーン上に描画する場合と変わりません。ClockViewクラスでは、オフスクリーン描画が済むと同時にDraw()メソッドを直接呼び出し、表示内容を更新しています。<br/>

<br/>

ClockViewクラスのDraw()メソッドでは、オフスクリーン描画の内容をスクリーンにコピーします。これは、スクリーンに表示されているビューオブジェクトに対してDrawBitmap()メソッドを呼び出すだけです。DrawBitmap()メソッドの引数には、表示内容を保存したBBitmapオブジェクト、すなわちオフスクリーン描画を行ったBBitmapオブジェクトを引数に渡します。リスト7.10のClockViewクラスのDraw()メソッドを見て下さい。DrawBitmap()メソッドの第一引数に、オフスクリーン描画を行ったBBitmapオブジェクトを渡しています。なお、DrawBitmap()メソッドの第二引数と第三引数には、コピー元の矩型領域とコピー先の矩型領域を指定します。ここでは、どちらにもDraw()メソッドが受け取った引数をそのまま渡しています。<br/>

<br/>

<div id="column">
<a href="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/column7.1.html" target="new"><span id="column_t">囲みコラム</span><br/>「オフスクリーンと描画領域」
</a></div>

さて、表示内容を更新する際のちらつき防止にBBitmapクラスを利用するやり方は、改良版のClockViewクラスのソースを見て分かりました。次は、改良版のWaveViewクラスを見てみましょう。このクラスでは、再描画のためのバックアップとしてBBitmapを利用しています。リスト7.12を見て下さい。<br/>

<br/>

リスト7.12に示した改良版のWaveViewクラスでは、スクリーンとオフスクリーンに対し、Pulse()メソッドの中で同じ内容を同時に描画しています。リスト7.8の改良前バージョンとは違い、同じ内容の描画処理を二回行うので、描画処理部分をPulse()メソッドから分割してDrawWave()メソッドにしました。Pulse()メソッドで行ったオフスクリーン描画の内容は、BBitmapオブジェクト内のオフスクリーンバッファに保存され、再描画が必要になった時に利用します。つまり、"Wave Window"が他のウィンドウで隠されたときなど、再描画が必要になるとDraw()メソッドが呼び出されますが、ClockViewクラスの場合と同様、DrawBitmap()メソッドを使ってオフスクリーンバッファの内容をスクリーンへコピーしています。<br/>

<br/>

以上で、BBitmapクラスを利用したオフスクリーン描画に関する説明は終わりです。次の節では、イベントスケジューリングに使っているTimeKeeperクラスの説明を行いますが、それでこの章も終わりです。<br/>

<br/>

<span id="annotate"><dl><dt>(注)7-3</dt><dd>BBitmapクラスは、アイコンのようなビットマップデータのコンテナとして利用することもできます。BBitmapをアイコンデータの保存と表示に利用する例は、第9章のサンプルで示します。</dd></dl></span>
<br/>

<br/>

<br/>
<a name="7.3"></a>
<h2>7.3&nbsp;&nbsp;マルチスレッドとメッセージ</h2>
冒頭に掲げた三つの題材のうち、最後の一つが未だ残っています。それを仕上げて終わりにしましょう。最後の題材は、イベントスケジューリングです。本章の説明に使っているサンプルアプリケーション(ClockworkWave)では、TimeKeeperというクラスを使ってイベントスケジューリング機能を実現していると7.1.1で述べました。このクラスは、登録されたイベント情報に従い、決まった時刻にメッセージを送ります。メッセージの内容と送信先は、イベントを発生させる時刻と一緒にイベント情報として登録します。<br/>

<br/>

細かい話しをする前に、まずTimeKeeperクラスのソースを見ておくことにします。リスト7.15と7.16を見て下さい。<br/>

<br/>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.15] TimeKeeper.hの内容</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#ifndef</font></b> _TIME_KEEPER_H_
<b><font color="#000080">#define</font></b> _TIME_KEEPER_H_

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Locker.h&gt;</font>

<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 関連クラス・構造体 </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">struct</font></b>	TaskInfo<font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メッセージ送付のスケジュール情報(ScheduleInfo)</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">struct</font></b> ScheduleInfo <font color="#FF0000">{</font>
    BHandler<font color="#990000">*</font> client<font color="#990000">;</font>     <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージを送る相手 </font></i><i><font color="#9A1900">*/</font></i>
    BMessage<font color="#990000">*</font> message<font color="#990000">;</font>    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 送付するメッセージ </font></i><i><font color="#9A1900">*/</font></i>
    int32     period<font color="#990000">;</font>     <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージを送る間隔(秒単位) </font></i><i><font color="#9A1900">*/</font></i>
    uint32    first_time<font color="#990000">;</font> <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 最初にメッセージを送る時刻(秒単位) </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * TimeKeeperクラスの定義</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">class</font></b> TimeKeeper <font color="#FF0000">{</font>
<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メソッド</font></i>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> 初期化と解放</font></i>
    <b><font color="#000000">TimeKeeper</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#990000">~</font><b><font color="#000000">TimeKeeper</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> イベントスケジューリング</font></i>
    status_t <b><font color="#000000">InsertSchedule</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> ScheduleInfo<font color="#990000">&amp;</font> inSchedule<font color="#990000">)</font><font color="#990000">;</font>
    status_t <b><font color="#000000">RemoveSchedule</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> BHandler<font color="#990000">*</font> inClient<font color="#990000">,</font> uint32 theCode<font color="#990000">)</font><font color="#990000">;</font>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    <font color="#009900">void</font>     <b><font color="#000000">CheckTask</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> クラスメソッド</font></i>
    <b><font color="#0000FF">static</font></b> int32 <b><font color="#000000">WatchClients</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">*</font> data<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">static</font></b> <font color="#009900">int</font>   <b><font color="#000000">CompareTasks</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> <font color="#009900">void</font><font color="#990000">*</font> inTaskA<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">void</font><font color="#990000">*</font> inTaskB<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">//</font></i><i><font color="#9A1900"> メッセージ送付タスクの操作</font></i>
    status_t <b><font color="#000000">ExecuteHeadTask</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">;</font>
    status_t <b><font color="#000000">AddTask</font></b><font color="#990000">(</font>TaskInfo<font color="#990000">*</font> inTask<font color="#990000">)</font><font color="#990000">;</font>
    int32    <b><font color="#000000">FindTask</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> BHandler<font color="#990000">*</font> inClient<font color="#990000">,</font> uint32 theCode<font color="#990000">)</font><font color="#990000">;</font>

<i><font color="#9A1900">//</font></i><i><font color="#9A1900"> データメンバ</font></i>
<b><font color="#0000FF">private</font></b><font color="#990000">:</font>
    thread_id fWatcher<font color="#990000">;</font>     <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 監視動作用のスレッド </font></i><i><font color="#9A1900">*/</font></i>
    bigtime_t fWatchPeriod<font color="#990000">;</font> <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 監視スレッドのスリープ間隔(u秒単位) </font></i><i><font color="#9A1900">*/</font></i>
    BList<font color="#990000">*</font>    fTaskList<font color="#990000">;</font>    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージ送付タスクのリスト </font></i><i><font color="#9A1900">*/</font></i>
    BLocker   fLocker<font color="#990000">;</font>      <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 自身のロック用 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<b><font color="#000080">#endif</font></b>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> _TIME_KEEPER_H_ </font></i><i><font color="#9A1900">*/</font></i>
</tt></pre>
</code>
</div>

<div id="listbox">
<code>
<span id="sourceH">[リスト7.16] TimeKeeper.cpの内容</span><br/><!-- Generator: GNU source-highlight 2.1.2
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"TimeKeeper.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"KGUtility/kgDebug.h"</font>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;support/Debug.h&gt;</font>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> メッセージ送付タスク </font></i><i><font color="#9A1900">*/</font></i>
<b><font color="#0000FF">struct</font></b> TaskInfo <font color="#FF0000">{</font>
    uint32        exec_time<font color="#990000">;</font>	<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 遂行時刻 </font></i><i><font color="#9A1900">*/</font></i>
    ScheduleInfo  schedule<font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> スケジュール情報 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font><font color="#990000">;</font>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> TimeKeeperクラスの非公開メソッド </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * イベントスケジューリング; TimeKeeper</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#009900">void</font>
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">CheckTask </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BAutolock	<b><font color="#000000">lock</font></b><font color="#990000">(</font>fLocker<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 指定時刻に達している全てのタスクを実行 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">while</font></b> <font color="#990000">(</font><font color="#990000">!</font> fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsEmpty</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        TaskInfo<font color="#990000">*</font>	headTask <font color="#990000">=</font> <font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FirstItem</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
	
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>headTask<font color="#990000">-</font><font color="#990000">&gt;</font>exec_time <font color="#990000">&gt;</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">real_time_clock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 必要なタスクの実行が終了 </font></i><i><font color="#9A1900">*/</font></i>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ExecuteHeadTask</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 必要なら監視スレッドを停止 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsEmpty</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">suspend_thread</font></b><font color="#990000">(</font>fWatcher<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * クラスメソッド; TimeKeeper</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
int32
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">WatchClients </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">*</font> data<font color="#990000">)</font>
<font color="#FF0000">{</font>
    TimeKeeper<font color="#990000">*</font>	theObj <font color="#990000">=</font> <font color="#990000">(</font>TimeKeeper<font color="#990000">*</font><font color="#990000">)</font>data<font color="#990000">;</font>
	
    <b><font color="#0000FF">while</font></b> <font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
        <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 必要な時間だけスリープ </font></i><i><font color="#9A1900">*/</font></i>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">snooze</font></b><font color="#990000">(</font>theObj<font color="#990000">-</font><font color="#990000">&gt;</font>fWatchPeriod<font color="#990000">)</font><font color="#990000">;</font>

        <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> タスクをチェック </font></i><i><font color="#9A1900">*/</font></i>
        theObj<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">CheckTask</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">int</font>
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">CompareTasks </font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> <font color="#009900">void</font><font color="#990000">*</font> inTaskA<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">void</font><font color="#990000">*</font> inTaskB<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#009900">int</font>    retVal <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
    uint32 timeA  <font color="#990000">=</font> <font color="#990000">(</font><font color="#990000">*</font><font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">*</font><font color="#990000">)</font>inTaskA<font color="#990000">)</font><font color="#990000">-</font><font color="#990000">&gt;</font>exec_time<font color="#990000">;</font>
    uint32 timeB  <font color="#990000">=</font> <font color="#990000">(</font><font color="#990000">*</font><font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">*</font><font color="#990000">)</font>inTaskB<font color="#990000">)</font><font color="#990000">-</font><font color="#990000">&gt;</font>exec_time<font color="#990000">;</font>
	
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>timeA <font color="#990000">&lt;</font> timeB<font color="#990000">)</font>
        retVal <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>timeA <font color="#990000">&gt;</font> timeB<font color="#990000">)</font>
        retVal <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b> retVal<font color="#990000">;</font>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 注意:BListの要素間比較手続きには、要素そのもの(ポインタ)ではなく、要</font></i>
<i><font color="#9A1900"> *		素の配列、すなわちポインタ配列が渡される。このため、渡された引数</font></i>
<i><font color="#9A1900"> *		に対して参照解除(dereference)する必要があるので注意すること。</font></i>
<i><font color="#9A1900"> *		('98. 1/7, </font></i><u><font color="#0000FF">koga@ftgun.co.jp</font></u><i><font color="#9A1900">)</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * メッセージ送付タスクの操作; TimeKeeper</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
status_t
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">ExecuteHeadTask </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t  sts<font color="#990000">;</font>
    TaskInfo<font color="#990000">*</font> theTask<font color="#990000">;</font>
    BLooper<font color="#990000">*</font>  target<font color="#990000">;</font>

    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font><font color="#990000">!</font> fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsEmpty</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 先頭のタスク情報を取得 </font></i><i><font color="#9A1900">*/</font></i>
    theTask <font color="#990000">=</font> <font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FirstItem</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    target  <font color="#990000">=</font> theTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>client<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">Looper</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font>target <font color="#990000">!</font><font color="#990000">=</font> NULL<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#000000">ASSERT</font></b><font color="#990000">(</font>theTask<font color="#990000">-</font><font color="#990000">&gt;</font>exec_time <font color="#990000">&lt;</font><font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">real_time_clock</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 送り先にメッセージを送付 </font></i><i><font color="#9A1900">*/</font></i>
    sts <font color="#990000">=</font> target<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">PostMessage</font></b><font color="#990000">(</font>
        theTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>message<font color="#990000">,</font> theTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>client<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveItem</font></b><font color="#990000">(</font>theTask<font color="#990000">)</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 先頭要素をリストから削除 </font></i><i><font color="#9A1900">*/</font></i>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 繰り返し処理なら再度追加 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>theTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>period <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        theTask<font color="#990000">-</font><font color="#990000">&gt;</font>exec_time <font color="#990000">+</font><font color="#990000">=</font> theTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>period<font color="#990000">;</font>
        sts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddTask</font></b><font color="#990000">(</font>theTask<font color="#990000">)</font><font color="#990000">;</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">return</font></b> B_OK<font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"TimeKeeper::ExecuteHeadTask"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> sts<font color="#990000">;</font>
<font color="#FF0000">}</font>

status_t
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">AddTask </font></b><font color="#990000">(</font>TaskInfo<font color="#990000">*</font> inTask<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> リストの先頭に要素を追加 </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddItem</font></b><font color="#990000">(</font>inTask<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> リスト要素を昇順でソート </font></i><i><font color="#9A1900">*/</font></i>
    fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">SortItems</font></b><font color="#990000">(</font>CompareTasks<font color="#990000">)</font><font color="#990000">;</font>

    <b><font color="#0000FF">return</font></b> B_OK<font color="#990000">;</font>
<font color="#FF0000">}</font>

int32
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">FindTask </font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> BHandler<font color="#990000">*</font> inHandler<font color="#990000">,</font> uint32 theCode<font color="#990000">)</font>
<font color="#FF0000">{</font>
    int32	theIndex <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">;</font>

    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>int32 i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> n <font color="#990000">=</font> fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">CountItems</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> n<font color="#990000">;</font> <font color="#990000">+</font><font color="#990000">+</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
        TaskInfo<font color="#990000">*</font>	aTask <font color="#990000">=</font> <font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">ItemAt</font></b><font color="#990000">(</font>i<font color="#990000">)</font><font color="#990000">;</font>
		
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>aTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>client <font color="#990000">=</font><font color="#990000">=</font> inHandler
                <font color="#990000">&amp;</font><font color="#990000">&amp;</font> aTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what <font color="#990000">=</font><font color="#990000">=</font> theCode<font color="#990000">)</font> <font color="#FF0000">{</font>
            theIndex <font color="#990000">=</font> i<font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
	
    <b><font color="#0000FF">return</font></b> theIndex<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> TimeKeeperクラスの公開メソッド </font></i><i><font color="#9A1900">*/</font></i>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 初期化と解放; TimeKeeper</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">TimeKeeper </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    fWatcher     <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">;</font>
    fTaskList    <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">BList</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    fWatchPeriod <font color="#990000">=</font> <font color="#993399">500</font> <font color="#990000">*</font> <font color="#993399">1000</font><font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 0.5秒 </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font>

TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><font color="#990000">~</font><b><font color="#000000">TimeKeeper </font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
    BAutolock	<b><font color="#000000">lock</font></b><font color="#990000">(</font>fLocker<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> スレッドが生きていたら停止して解放 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fWatcher <font color="#990000">&gt;</font><font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">)</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><b><font color="#000000">kill_thread</font></b><font color="#990000">(</font>fWatcher<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 不要になったスケジュール情報を解放 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">while</font></b> <font color="#990000">(</font><font color="#990000">!</font> fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsEmpty</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        TaskInfo<font color="#990000">*</font>	aTask <font color="#990000">=</font> <font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveItem</font></b><font color="#990000">(</font><font color="#990000">(</font>int32<font color="#990000">)</font><font color="#993399">0</font><font color="#990000">)</font><font color="#990000">;</font>
		
        <b><font color="#0000FF">delete</font></b> aTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>message<font color="#990000">;</font>
        <b><font color="#0000FF">delete</font></b> aTask<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">delete</font></b> fTaskList<font color="#990000">;</font>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 注意:ここでは自身にロックをかけて排他制御を行っているが、これは完全</font></i>
<i><font color="#9A1900"> *		なものではない。InsertSchedule()やRemoveSchedule()が、デストラ</font></i>
<i><font color="#9A1900"> *		クタを呼び出したのとは別のスレッドから同時に呼び出された場合、</font></i>
<i><font color="#9A1900"> *		デストラクタによってfTaskListが解放された後にそれらのメソッドが</font></i>
<i><font color="#9A1900"> *		実行される可能性があるからである。すなわち、InsertSchedule()や</font></i>
<i><font color="#9A1900"> *		RemoveSchedule()がfTaskListにアクセスした際に、それが既に解放さ</font></i>
<i><font color="#9A1900"> *		れて無効な領域になっている可能性のあることを考慮していない。</font></i>
<i><font color="#9A1900"> *		ここでロックをかけているのは、fWatcherスレッドを kill する際に、</font></i>
<i><font color="#9A1900"> *		その実行が中途半端な状態で終わらないことを保障するのが目的であ</font></i>
<i><font color="#9A1900"> *		り、他のメソッドとの間での完全な排他制御を実現するものではない。</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> *		 なお、fTaskListを解放したらそれをNULLにセットし、他のメソッド</font></i>
<i><font color="#9A1900"> *		ではfTaskListがNULLかどうかをチェックするように *改良*したとし</font></i>
<i><font color="#9A1900"> *		ても、TimeKeeperクラスのインスタンス全体が占める領域はデストラ</font></i>
<i><font color="#9A1900"> *		クタの解放処理によって無効になるため、問題を解決したことにはな</font></i>
<i><font color="#9A1900"> *		らない。('98. 3/4, </font></i><u><font color="#0000FF">koga@ftgun.co.jp</font></u><i><font color="#9A1900">)</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * イベントスケジューリング; TimeKeeper</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
status_t
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">InsertSchedule </font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> ScheduleInfo<font color="#990000">&amp;</font> inSchedule<font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t  sts<font color="#990000">;</font>
    TaskInfo<font color="#990000">*</font> newTask <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TaskInfo</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">;</font>
    int32     theIndex<font color="#990000">;</font>
    BAutolock <b><font color="#000000">lock</font></b><font color="#990000">(</font>fLocker<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 既に同じスケジュールがあれば削除 </font></i><i><font color="#9A1900">*/</font></i>
    theIndex <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FindTask</font></b><font color="#990000">(</font>
        inSchedule<font color="#990000">.</font>client<font color="#990000">,</font> inSchedule<font color="#990000">.</font>message<font color="#990000">-</font><font color="#990000">&gt;</font>what<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>theIndex <font color="#990000">&gt;</font><font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">)</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveItem</font></b><font color="#990000">(</font>theIndex<font color="#990000">)</font><font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> タスクリストにエントリを追加 </font></i><i><font color="#9A1900">*/</font></i>
    newTask<font color="#990000">-</font><font color="#990000">&gt;</font>exec_time <font color="#990000">=</font> inSchedule<font color="#990000">.</font>first_time<font color="#990000">;</font>
    newTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule  <font color="#990000">=</font> inSchedule<font color="#990000">;</font>
    sts <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">AddTask</font></b><font color="#990000">(</font>newTask<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 必要なら監視スレッドを生成して起動 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fWatcher <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        fWatcher <font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">spawn_thread</font></b><font color="#990000">(</font>
            WatchClients<font color="#990000">,</font> <font color="#FF0000">"watcher"</font><font color="#990000">,</font> B_NORMAL_PRIORITY<font color="#990000">,</font> <b><font color="#0000FF">this</font></b>
        <font color="#990000">)</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    sts <font color="#990000">=</font> <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">resume_thread</font></b><font color="#990000">(</font>fWatcher<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>sts <font color="#990000">!</font><font color="#990000">=</font> B_OK<font color="#990000">)</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b> B_OK<font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"TimeKeeper::InsertSchedule"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> sts<font color="#990000">;</font>
<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900"> * 注意:上では無条件に resume_thread() を実行しているが、suspend してい</font></i>
<i><font color="#9A1900"> *		ないスレッドに対しては、この手続きは何もしない。したがって、これ</font></i>
<i><font color="#9A1900"> *		で問題はない。('97. 12/20, </font></i><u><font color="#0000FF">koga@ftgun.co.jp</font></u><i><font color="#9A1900">)</font></i>
<i><font color="#9A1900"> </font></i><i><font color="#9A1900">*/</font></i>
<font color="#FF0000">}</font>

status_t
TimeKeeper<font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">RemoveSchedule </font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> BHandler<font color="#990000">*</font> inClient<font color="#990000">,</font> uint32 theCode<font color="#990000">)</font>
<font color="#FF0000">{</font>
    status_t  sts<font color="#990000">;</font>
    TaskInfo<font color="#990000">*</font> theTask<font color="#990000">;</font>
    BAutolock <b><font color="#000000">lock</font></b><font color="#990000">(</font>fLocker<font color="#990000">)</font><font color="#990000">;</font>

    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> タスクリストからエントリを削除 </font></i><i><font color="#9A1900">*/</font></i>
    theTask <font color="#990000">=</font> <font color="#990000">(</font>TaskInfo<font color="#990000">*</font><font color="#990000">)</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">RemoveItem</font></b><font color="#990000">(</font>
        <b><font color="#0000FF">this</font></b><font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">FindTask</font></b><font color="#990000">(</font>inClient<font color="#990000">,</font> theCode<font color="#990000">)</font>
    <font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><font color="#990000">!</font> theTask<font color="#990000">)</font> <font color="#FF0000">{</font>
        sts <font color="#990000">=</font> B_ERROR<font color="#990000">;</font>
        <b><font color="#0000FF">goto</font></b> err<font color="#990000">;</font>  <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 見つからない </font></i><i><font color="#9A1900">*/</font></i>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">delete</font></b> theTask<font color="#990000">-</font><font color="#990000">&gt;</font>schedule<font color="#990000">.</font>message<font color="#990000">;</font>
    <b><font color="#0000FF">delete</font></b> theTask<font color="#990000">;</font>
	
    <i><font color="#9A1900">/*</font></i><i><font color="#9A1900"> 必要なら監視スレッドを停止 </font></i><i><font color="#9A1900">*/</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fTaskList<font color="#990000">-</font><font color="#990000">&gt;</font><b><font color="#000000">IsEmpty</font></b><font color="#990000">(</font><font color="#990000">)</font><font color="#990000">)</font>
        <font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font><font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">suspend_thread</font></b><font color="#990000">(</font>fWatcher<font color="#990000">)</font><font color="#990000">;</font>
	
    <b><font color="#0000FF">return</font></b> B_OK<font color="#990000">;</font>
err<font color="#990000">:</font>
    <font color="#990000">:</font><font color="#990000">:</font><b><font color="#000000">Error</font></b><font color="#990000">(</font><font color="#FF0000">"TimeKeeper::RemoveSchedule"</font><font color="#990000">,</font> sts<font color="#990000">)</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> sts<font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
</code>
</div>

<br/>

<br/>
<a name="7.3.1"></a>
<h3>7.3.1&nbsp;&nbsp;いつになったら起こせばいいの</h3>
リスト7.15に示したTimeKeeperクラスの定義を見ると、このクラスはthread_id型のデータメンバを持っており、内部に専用のスレッドを持つらしいことが分かります。リスト7.16の実装部を読むと分かりますが、このスレッドは必要に応じてインスタンス内部に生成され、登録されたイベントを発生させるべき時刻に達したかどうかを調べる監視動作を行います。<br/>

<br/>

スレッドの生成は、InsertSchedule()メソッドの中で行います。このメソッドは、TimeKeeperオブジェクトにイベント情報を登録するために呼び出されるものです。実際の利用例は、リスト7.10やリスト7.12、またリスト7.14を参照して下さい。InsertSchedule()メソッドでは、引数に受け取ったイベント情報をまず内部のリスト(fTaskList)に追加します(注7-4)。それが済んだら監視用のスレッドが生成済みかどうかを調べ、まだであれば、spawn_thread()を呼び出して生成します。spawn_thread()はKernel Kitで提供されているスレッド生成手続きで、生成したスレッドのIDを戻り値として返します。以下に、spawn_thread()が受け取る引数の説明を示します。なお、spawn_thread()を呼び出してスレッドを生成しても、それだけではスレッドを動作させることはできません。生成された直後のスレッドは停止状態なので、resume_thread()を呼び出して実行可能状態に遷移させることが必要です。Kernel Kitが提供しているスレッド操作APIの詳細については、APIリファレンスを参照して下さい。<br/>

<br/>

 ○第一引数(thread_func)<br/>

  生成したスレッドが実行すべき手続きや関数を指した、関数ポインタを指定します。thread_funcという型は、void*型の引数を受け取ってint32型の戻り値を返す関数の関数ポインタを表わします。<br/>

<br/>

 ○第二引数(const char*)<br/>

  スレッドの名前を指定します。<br/>

<br/>

 ○第四引数(int32)<br/>

  スレッドが実行される際の優先度を指定します。優先度は1以上の任意の値を指定できますが、Kernel Kitでは七つの値が定義されています。<br/>

<br/>

 ○第五引数(void*)<br/>

  スレッドが実行する手続き、すなわち第一引数に渡された手続きに渡す引数を指定します。<br/>

<br/>

さて、InsertSchedule()メソッドでは、監視スレッドを生成したのかどうかに関係なくresume_thread()を呼び出していますが、これはプログラミングの間違いではありません。後で述べるように、登録されたイベントの数が0になり、監視を続ける必要がなくなると、監視スレッドが停止されてしまうからなのです。その説明に進む前に、イベント発生時刻の監視とイベントを起こす処理の説明を済ませてしまいましょう。<br/>

<br/>

<div id="column">
<a href="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/column7.2.html" target="new"><span id="column_t">囲みコラム</span><br/>「snooze()によるCPUの明け渡し」
</a></div>

CheckTask()メソッドでは、登録されているイベント情報を格納したリスト(fTaskList)を先頭から順に調べ、指定された時刻に達しているものがあれば、ExecuteHeadTask()メソッドを呼び出してイベントを起こします。ExecuteHeadTask()メソッドでは、イベント情報に従い、指定された宛先にメッセージを送ります。なお、TimeKeeperクラスでは繰り返しのない、つまり一度しか起きないイベントも登録できますが、その処理もExecuteHeadTask()で行います。すなわち、イベントを起こした際にその情報をリストから削除し、繰り返し間隔が指定されているものだけをリストに追加し直すのです。繰り返し間隔は0より大きな整数(秒単位)なので、0以下の無効値が指定された場合は、繰り返しは行われません。<br/>

<br/>

<br/>
<a name="7.3.2"></a>
<h3>7.3.2&nbsp;&nbsp;モーニングコールの取消し</h3>
イベント情報の登録と監視処理の説明が済んでしまいましたので、次はイベント情報の削除処理について説明します。TimeKeeperオブジェクトに登録したイベント情報の削除処理にはRemoveSchedule()メソッドを使いますが、そもそも、そんなことは必要なんでしょうか?そう思った人は、リスト7.10や7.12を読み返してみて下さい。もし登録したイベントを削除できないとすれば、ClockworkWaveアプリケーションの時刻表示ウィンドウを閉じた時、TimeKeeperオブジェクトは既に存在していない依頼主に向けて、受け取ってもらえるはずのないメッセージを送ることになるでしょう。また、あなたがこのサンプルアプリケーションを改造し、時刻表示ウィンドウに目覚まし時計の機能を追加するとしたら、きっと一度セットした目覚まし時刻を解除するための機能も付けたくなるはずです。<br/>

<br/>

RemoveSchedule()メソッドが必要なことが分かったら、その内部を見てみましょう。といっても、リスト7.16を見れば分かるように、このメソッドでやっていることは実に単純です。引数で指定されたイベント情報をリストから削除し、不要になった領域を解放した後、必要であれば監視スレッドを停止するだけなのです。スレッドを停止するには、suspend_thread()手続きを使います。この手続きもKernel Kitで提供されているもので、指定したスレッドを生成直後と同じ状態、すなわち停止状態に遷移させます。なお、先ほど説明したCheckTask()でもsuspend_thread()を呼び出す場合がありますが、これは一度しか起こす必要のないイベントもあるため、全てのイベントを発生し終わった後、残っているイベント情報の数が0になってしまう場合があるためです。<br/>

<br/>

このように、WatchClients()メソッドによって監視を続けている合間に監視スレッドが動作を停止してしまう場合があります。したがって、InsertSchedule()では、渡されたイベント情報を登録するたびにresume_thread()を呼び出し、たとえ監視スレッドが停止状態になっていても、動作が再開されるようにしているのです。<br/>

<br/>

ところで、TimeKeeperオブジェクトに登録されたイベント情報は、BListクラスのインスタンスに格納して管理していますが、このクラスについての説明が未だでした。ここで簡単に紹介しておきましょう。BListはSupport Kitで提供されているクラスで、匿名ポインタ(void*)を要素とする汎用のリストクラスです。リスト要素に対する型検査を行えないという欠点はありますが、単純なリスト処理に利用するのであれば便利なクラスです(注7-5)。<br/>

<br/>

以下に、本章のサンプルで利用しているBListクラスのメソッドの説明を示します。それぞれのメソッドの詳細については、APIリファレンスを参照して下さい。<br/>

<br/>

 ○IsEmpty()<br/>

  リストが空かどうかを調べ、その結果を返します。<br/>

<br/>

 ○FirstItem()<br/>

  リストの先頭要素を返します。<br/>

<br/>

 ○ItemAt()<br/>

  引数で指定した位置にあるリスト要素を返します。なお、引数に渡すインデックスは、先頭要素を0、そして末尾要素を(全要素数 - 1)で指定します。<br/>

<br/>

 ○AddItem()<br/>

  第一引数に渡した要素を、第二引数で指定した位置に挿入します。このメソッドは多重定義されており、引数を一つしか受け取らないバージョンがあります。そのメソッドを使った場合、引数に渡した要素はリストの末尾に追加されます。<br/>

<br/>

 ○RemoveItem()<br/>

  引数で指定した要素をリストから削除します。このメソッドは多重定義されており、削除する要素(ポインタ)自体を引数に渡すバージョンと、削除する要素の位置を示すインデックスを渡すバージョンの二つがあります。<br/>

<br/>

 ○SortItems()<br/>

  引数に渡した要素比較関数を使い、リスト要素をソートします。<br/>

<br/>

<br/>
<a name="7.3.3"></a>
<h3>7.3.3&nbsp;&nbsp;取り込み中につきお待ち下さい</h3>
この章の説明もほとんど終わりましたが、まだ一つだけ残っています。それは、マルチスレッド処理で必要な排他制御に関することです。排他制御についてよく分からない人は、5.2節の説明を読み返してみるのが良いかも知れません。5.2節では、ウィンドウに描画する時はウィンドウをロックする必要があることを示しました。これは、一つのウィンドウに対して同時に複数のスレッドが描画を行う可能性があるためでした。つまり、ロックをかけることにより、一時に一つのスレッドしか描画できないようにして衝突を防ぐのです。これと同じことが、TimeKeeperオブジェクトに対しても言えます。<br/>

<br/>

本章の説明で使っているClockworkWaveアプリケーションでは、二つのビューオブジェクトが一つのTimeKeeperオブジェクトを共有しています。二つのビューオブジェクトは異なるウィンドウに所属しており、それぞれのウィンドウスレッドによって互いに並行動作します。さらに、これに加えてTimeKeeperオブジェクトが内部に持つ監視用のスレッドがありますから、合計三つのスレッドが同時にTimeKeeperオブジェクトをアクセスすることになるのです。これら三つのスレッドの関係を、図7.6に示します。<br/>

<br/>

<div id="imagebox">
<img src="https://www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/img/7.06.jpg" alt="図 ClockworkWaveの動作モデル図"/><div>図[7.6]  ClockworkWaveの動作モデル図</div>
</div>

<br/>

リスト7.16を注意深く読んだ人は、TimeKeeperクラスのInsertSchedule()メソッドとRemoveSchedule()メソッド、そしてCheckTask()メソッドでは、特別なことをやっているのに気付いたかも知れませんね。これらのメソッドでは、どれも本体中でBAutolockクラス型の変数を宣言しています。また、変数宣言する際、コンストラクタの引数にはBLockerクラス型のデータメンバ(fLocker)が渡されるようにしています。これは、これらのメソッドが実行されている間、TimeKeeperオブジェクトにロックがかかるようにするためのものです。BAutolockとBLockerは、どちらもSupport Kitで提供されているクラスで、これらを使うと排他制御のためのロック処理を簡単にプログラミングできます。それぞれのクラスについて、以下に簡単な説明を示します。<br/>

<br/>

 ○BAutolock<br/>

  コンストラクタの引数に渡された、BLockerオブジェクトまたはBLooperオブジェクトにロックをかけます。このロックは、デストラクタの中で解除されます。したがって、特定の手続きやブロック内で一時的にロックをかけたい場合、このクラス型の変数を宣言し、ロックをかけるオブジェクトをコンストラクタの引数に渡せばロックとその解除が自動的に行われます。<br/>

<br/>

 ○BLocker<br/>

  Lock()メソッドが呼び出されると自身にロックをかけ、Unlock()メソッドによってロックを解除します。ただし、Lock()メソッドを呼び出したのとは違うスレッドがUnlock()メソッドを呼び出しても、ロックは解除されません。また、一度Lock()メソッドによってロックがかけられると、その後で他のスレッドがLock()メソッドを呼び出しても、ロックが解除されるまで待たされます。BLooperが持っているのと同様のロック機能を提供するクラスです。<br/>

<br/>

リスト7.16では、BLockerクラスとBAutolockクラスを利用してロック処理を行っています。TimeKeeperオブジェクトにアクセスする三つのスレッドは、InsertSchedule()とRemoveSchedule()、そしてCheckTask()のどれかを呼び出しますが、これらのメソッドが実行されている間はTimeKeeperオブジェクトにロックがかけられます。したがって、複数のスレッドが同時にTimeKeeperオブジェクトのメソッドを呼び出しても、ロックの獲得に成功したもの以外の残りのスレッドは、ロックが解除されるまで待たされます。ロックが解除されるのは、ロックを獲得したスレッドがメソッド呼び出しを終えた時ですから、これらのメソッドが異なるスレッドによって同時に呼び出されても、結果として一つずつ順番に実行されます。つまり、スレッド同士のメソッド呼び出し処理が衝突し、TimeKeeperオブジェクトが管理するイベント情報の内容が壊れてしまう、という心配はありません。<br/>

<br/>

さて、図7.6をもう一度見てみましょう。この図では、一つ気になることがあります。まず、ClockViewおよびWaveViewオブジェクトがイベント情報の登録または削除を行う場合、上で述べたようにTimeKeeperオブジェクトに対してメソッド呼び出しを行います。一方、TimeKeeperオブジェクト内の監視スレッドは、イベントの生起をビューオブジェクトに通知する際、それぞれが所属するBLooperオブジェクトに対してPostMessage()を呼び出し、メッセージを送っているのです。これはどうしてだと思いますか?<br/>

<br/>

TimeKeeperオブジェクトがイベントの生起を通知する際、通知先オブジェクトのメソッドを直接呼び出すのではなく、PostMessage()によるメッセージ通信を利用するのには、次の二つの理由があります。<br/>

<br/>

 (1)通知先オブジェクトの抽象化<br/>

  通知先オブジェクトのメソッド、この章のサンプルで言えばClockViewのUpdateTime()メソッドや、WaveViewのUpdateColor()メソッドを呼び出すとすれば、通知先オブジェクトに関する具体的な知識が要求されます。言い換えると、TimeKeeperクラスが通知先オブジェクトのクラスに依存してしまい、他のアプリケーションで再利用することができなくなります。PostMessage()という共通のインタフェースを利用することで、通知先オブジェクトをBHandlerクラスに抽象化し、TimeKeeperクラスの再利用を可能にしています。<br/>

<br/>

 (2)非同期処理による効率化<br/>

  第3章で述べたように、PostMessage()メソッドは引数に渡したメッセージが処理されるのを待たず、すぐに呼び出し側へ制御を戻します。これに対し、通知先オブジェクトのメソッドを直接呼び出すとすれば、そのメソッドの実行が終わるまでTimeKeeperオブジェクト(内の監視スレッド)は待たされることになります。その結果、イベント通知のタイミング遅れが生じてしまうでしょう。PostMessage()によるメッセージ通信を利用すれば、通知先オブジェクト側での処理の完了を待たない、非同期処理を実現できます。それにより、マルチスレッド動作の効率が上がり、より正確なタイミングでイベント通知を行えるのです。<br/>

<br/>

TimeKeeperクラスでメッセージ通信を使うことの利点を上に述べましたが、それでは全てをメッセージ通信で置き換えたらどうなるでしょう?この後の練習問題の中には、イベントの登録や削除をメッセージ通信で行えるようにするには、どうすればよいか考えるものがあります。自分なりの答えを出してみて下さい。さらに、次の第8章では、異なるアプリケーション同士がメッセージ通信することにより、どんなことが可能になるかを考えてみようと思います。<br/>

<br/>

<span id="annotate"><dl><dt>(注)7-4</dt><dd>TimeKeeperクラスでは、イベント情報を受け取った後、それを内部で使う「タスク情報(TaskInfo)」に変換してからリストに格納します。TaskInfo構造体は、TimeKeeper.cp(リスト7.16)で定義されています。</dd></dl></span>
<br/>

<span id="annotate"><dl><dt>(注)7-5</dt><dd>BListクラスのラッパー(wrapper)として働くテンプレートクラスを定義すれば、リスト要素に対する型検査機能を実現できます。また、一般的なリストや集合クラスをふんだんに使う場合には、標準化されたテンプレートクラスライブラリ(STL)を利用するのもよいでしょう。STLはCodeWarrior for BeOSに付属しています。ただし、STLを使うとアプリケーションのファイルサイズが大きくなり、BeOS付属の機能限定版のリンカが扱える制限(64KB)を超えてしまう場合があります。</dd></dl></span>
<br/>

<br/>
<a name="7.4"></a>
<h2>7.4&nbsp;&nbsp;まとめと練習問題</h2>
この章では、最初に挙げた題材をプログラミングするために、次のような解決手段を用いました:<br/>

<br/>

 ■動きのある画面表示、つまりアニメーションの描画<br/>

  →BViewクラスのPulse()メソッドを利用して、一定間隔で画面を更新する。<br/>

<br/>

 ■画面更新時のちらつきを抑えるための、オフスクリーン描画<br/>

  →BBitmapオブジェクトにオフスクリーン描画用のBViewオブジェクトを貼りつけて描画した後、BViewクラスのDrawBitmap()メソッドを使ってスクリーン(VRAM)へ転送する。<br/>

<br/>

 ■二つのウィンドウで行われる処理のタイミングを合わせるのに必要な、イベントスケジューリング<br/>

  →イベント発生用のスレッドを動作させ、BWindow(BLooper)クラスのPostMessage()メソッドを使ってウィンドウにイベントを伝える。<br/>

<br/>

この章で説明したことや、説明に使ったサンプルアプリケーションに対する理解を深めるために、以下の練習問題について考えてみて下さい。<br/>

<br/>

 <div id="practice">練習問題 1</div>

  ClockViewクラスを改造し、TimeKeeperクラスを利用して時刻表示を更新するのはなく、Pulse()メソッドを利用して更新するようにしてみて下さい。<br/>

<br/>

 <div id="practice">練習問題 2</div>

  ClockViewクラスが受け付け可能なメッセージを一つ追加し、そのメッセージを受け取ったらbeep()を呼び出すようにして下さい。これで、ClockViewにメッセージを送るとビープ音を鳴らすようになります。それが終わったら、波紋表示ウィンドウで波紋の色が変わるのと同じタイミングでビープ音が鳴るようにして下さい。どうすればいいでしょうか。また、波紋表示ウィンドウが表示されている時にだけビープ音が鳴るようにするにはどうすればよいか、考えてみて下さい。<br/>

<br/>

 <div id="practice">練習問題 3</div>

  WaveViewクラスのPulse()メソッドでは、波紋を描画するのにStrokeEllipse()を一回とFillEllipse()を一回呼び出しています(ただし、初期状態は別)。実は、FillEllipse()を使わずにStrokeEllipse()を二回呼び出して描画することが可能です。そのように修正してみて下さい。<br/>

<br/>

 <div id="practice">練習問題 4</div>

  ウィンドウやビューのサイズと色深度が決まれば、それに対するオフスクリーンバッファが消費するメモリ量を計算することができます。例として、サイズが100 x 100、色深度が32bitのオフスクリーンバッファについて、バッファに必要なメモリ量を計算して下さい。<br/>

<br/>

 <div id="practice">練習問題 5</div>

  前の問題の計算に使ったのと同じ仕様、つまりサイズが100 x 100で色深度が32bitのBBitmapオブジェクトを生成するプログラムを書いて下さい。そのプログラムの中で、生成したBBitmapオブジェクトに対してBitsLength()メソッドを呼び出し、その戻り値を前の問題の計算結果と比べて下さい。<br/>

<br/>

 <div id="practice">練習問題 6</div>

  リスト7.10では、ClockViewクラスのUpdateTime()メソッドの中で直接Draw()メソッドを呼び出しています。これを、Invalidate()メソッドを呼び出して間接的にDraw()メソッドが呼び出されるように変更してみて下さい。変更したアプリケーションを動かすとどうなるでしょうか。その結果から、Invalidate()メソッドによる再描画処理の流れを想像して下さい。<br/>

<br/>

 <div id="practice">練習問題 7</div>

  TimeKeeperクラスでは、専用のスレッドを生成してイベントを発生時刻に達したかどうかを監視します。しかし、BApplicationクラスのPulse()メソッドを利用すれば専用のスレッドを使わなくても同じことができるはずです。ClockworkWaveAppクラスとTimeKeeperクラスを改造し、TimeKeeper専用のスレッドを使わないバージョンのアプリケーションを作ってみて下さい。<br/>

<br/>

 <div id="practice">練習問題 8</div>

  時計表示ウィンドウにメニュー項目を追加し、アラーム時刻を設定できるように改造して下さい。つまり、指定した時刻になるとビープ音を鳴らしたり、またあらかじめ設定しておいたサウンドファイルを再生したりできるようにしてみて下さい。どうすればよいでしょうか。これより後の章の説明も参考にして、実現方法を考えてみて下さい。<br/>

<br/>

 <div id="practice">練習問題 9</div>

  TimeKeeperクラスを改変し、BLooperのサブクラスとして実装し直してみて下さい。そして、イベントの登録と削除を指示するメッセージを受け取れるようにして下さい。つまり、InsertSchedule()メソッドやRemoveSchedule()メソッドを直接呼び出すのではなく、他のスレッドからメッセージを送って処理できるようにして下さい。<br/>

<br/>

<br/>

 <div id="practice">練習問題 10</div>

  ClockworkWaveアプリケーションに対し、他のアプリケーションからメッセージを送ってイベントを登録できるようにして下さい。前の問題ができていれば、必要な作業のうち半分は終わっています。残りの半分は、他のアプリケーションに所属しているBHandlerオブジェクトに対してメッセージを送れるようにすることです。その方法を次の章で説明しますので、参考にして下さい。<br/>

<br/>

<br/>

<br/>


<hr>
<address>
Art of BeOS Programming<br/>
koga@stprec.co.jp
</address>


</div><!-- End of main -->

</div><!-- End of pagewidth -->

<!-- Fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, 'https://metrics.haiku-os.org/tracker.js', 'fathom');
fathom('trackPageview');
</script>
<!-- / Fathom --></body>


<!-- Mirrored from www.haiku-os.org/legacy-docs/ArtOfBeOSProgramming/chapter/chapter07.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 05 Aug 2021 01:43:08 GMT -->
</html>

