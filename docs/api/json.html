<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from www.haiku-os.org/docs/api/json.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 05 Aug 2021 01:50:22 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=9"/>
	<meta name="generator" content="Doxygen 1.8.16"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>The Haiku Book: Json Handling</title>
	<link href="tabs.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="dynsections.js"></script>
	<link href="doxygen.css" rel="stylesheet" type="text/css" />
	<link href="book.css" rel="stylesheet" type="text/css"/>
	</head>
<body>
	<div id="banner">
		<div class="logo">
			<span class="subtitle">
				API Documentation
			</span>
			<span class="search">
				<input type="text" placeholder="Search" onkeydown="search(this,event);">
			</span>
		</div>
	</div>
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.html','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Json Handling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="http://www.json.org/">JSON</a> is a simple textual description of a data structure. An example of some JSON would be;</p>
<div class="fragment"><div class="line">[ <span class="stringliteral">&quot;apple&quot;</span>, <span class="stringliteral">&quot;orange&quot;</span>, { <span class="stringliteral">&quot;drink&quot;</span>: <span class="stringliteral">&quot;tonic water&quot;</span>, <span class="stringliteral">&quot;count&quot;</span> : 123 } ]</div>
</div><!-- fragment --><p>This example is a list that contains two strings followed by an "object". The term object refers to a construct akin to a "dictionary" or a "map". It is also possible for top-level objects to be non-collection types such as strings. The following is also valid JSON;</p>
<div class="fragment"><div class="line"><span class="stringliteral">&quot;fijoa&quot;</span></div>
</div><!-- fragment --><p>This page details how Haiku provides facilities for both parsing as well as writing data encoded as Json.</p>
<h1><a class="anchor" id="parsing-in-memory-model"></a>
Parsing with Generic In-Memory Model</h1>
<p>For some applications, parsing to an in-memory data structure is ideal. In such cases, the <code>BJson</code> class provides static methods for parsing a block of JSON data into a <code><a class="el" href="classBMessage.html" title="A container that can be send and received using the Haiku messaging subsystem.">BMessage</a></code> object. The application logic is then able to introspect the <code><a class="el" href="classBMessage.html" title="A container that can be send and received using the Haiku messaging subsystem.">BMessage</a></code> to obtain values.</p>
<h2><a class="anchor" id="bmessage-structure"></a>
BMessage Structure</h2>
<p>The <code><a class="el" href="classBMessage.html" title="A container that can be send and received using the Haiku messaging subsystem.">BMessage</a></code> class has the ability to carry a collection of key-value pairs. In the case of a Json object type, the key-value pairs correlate to a JSON object or array. In the case of a JSON array type, the key-value pairs are the index of the elements in the JSON array represented as strings.</p>
<p>For example, the following JSON array...</p>
<div class="fragment"><div class="line">[ <span class="stringliteral">&quot;a&quot;</span>, <span class="stringliteral">&quot;b&quot;</span>, <span class="stringliteral">&quot;c&quot;</span> ]</div>
</div><!-- fragment --><p>...would be represented by the following <code><a class="el" href="classBMessage.html" title="A container that can be send and received using the Haiku messaging subsystem.">BMessage</a></code> ;</p>
<table class="doxtable">
<tr>
<th>Key </th><th>Value  </th></tr>
<tr>
<td><code>"0"</code>  </td><td><code>"a"</code>   </td></tr>
<tr>
<td><code>"1"</code>  </td><td><code>"b"</code>   </td></tr>
<tr>
<td><code>"2"</code>  </td><td><code>"c"</code>   </td></tr>
</table>
<p>A Json object that, in its entirety, consists of a non-collection type such as a simple string or a boolean is not able to be represented by a <code><a class="el" href="classBMessage.html" title="A container that can be send and received using the Haiku messaging subsystem.">BMessage</a></code> ; at the top level there must be an array or an object for the parse to be successful.</p>
<h1><a class="anchor" id="parsing-streaming"></a>
Stream-based Parsing</h1>
<p>Streaming is useful in many situations;</p>
<ul>
<li>where handling the parsed data is easier to undertake as a stream of events</li>
<li>where the quantity of input or output data could be non-trivial and holding that quantity of material in memory is undesirable</li>
<li>where being able to start processing a stream of data before the entire payload has arrived is desirable</li>
</ul>
<p>This architecture is sometimes known as an event-based parser or a "SAX" parser.</p>
<p>The <code>BJson</code> class provides a static method that accepts a stream of Json data in the form of a <code><a class="el" href="classBDataIO.html" title="Abstract interface for objects that provide read and write access to data.">BDataIO</a></code>. A <code>BJsonEventListener</code> sub-class is also supplied and as each Json token is read-in from the stream, it will be provided to the listener. The listener must implement three callback methods to handle the Json tokens;</p>
<table class="doxtable">
<tr>
<th>Method </th><th>Description  </th></tr>
<tr>
<td><code>Handle</code>(..) </td><td>Provides JSON events to the listener  </td></tr>
<tr>
<td><code>HandleError</code>(..) </td><td>Signals parse or processing errors to the listener  </td></tr>
<tr>
<td><code>Complete</code>(..) </td><td>Informs the listener that parsing has completed  </td></tr>
</table>
<p>Events are embodied in instances of the <code>BJsonEvent</code> class and each of these has a type. Example types are;</p>
<ul>
<li><code>B_JSON_STRING</code> </li>
<li><code>B_JSON_OBJECT_START</code> </li>
<li><code>B_JSON_TRUE</code> </li>
</ul>
<p>In this way, the listener is able to interpret the incoming stream of data as Json and handle it in some way.</p>
<p>The following Json...</p>
<div class="fragment"><div class="line">{<span class="stringliteral">&quot;color&quot;</span>: <span class="stringliteral">&quot;red&quot;</span>, <span class="stringliteral">&quot;alpha&quot;</span>: 0.6}</div>
</div><!-- fragment --><p>Would yield the following stream of events;</p>
<table class="doxtable">
<tr>
<th>Event Type </th><th>Event Data  </th></tr>
<tr>
<td><code>B_JSON_OBJECT_START</code>  </td><td>-  </td></tr>
<tr>
<td><code>B_JSON_OBJECT_NAME</code>  </td><td>"color"  </td></tr>
<tr>
<td><code>B_JSON_STRING</code>  </td><td>"red"  </td></tr>
<tr>
<td><code>B_JSON_OBJECT_NAME</code>  </td><td>"alpha"  </td></tr>
<tr>
<td><code>B_JSON_NUMBER</code>  </td><td>0.6  </td></tr>
<tr>
<td><code>B_JSON_OBJECT_END</code>  </td><td>-  </td></tr>
</table>
<h2><a class="anchor" id="parsing-streaming-numbers"></a>
Number Handling</h2>
<p>The Json number literal format does not specify a numeric type such as <code>int32</code> or <code>double</code>. To cope with the widest range of possibilities, the <code>B_JSON_NUMBER</code> event type captures the content as a string and then the <code>BJsonEvent</code> object is able to provide the original string for specific handling as well as convenient accessors for parsing to <code>double</code> or <code>int64</code> types. This provides a high level of flexibility for the client.</p>
<h2><a class="anchor" id="parsing-streaming-stacked-listeners"></a>
Stacked Listeners</h2>
<p>One implementation approach for a listener implement that might be used to read a data-transfer-object (DTO) is to create "sub-listeners" that mirror the structure of the Json data.</p>
<p>In the following example, a nested data structure is being parsed.</p>
<div class="image">
<img src="stacked-listeners.svg" alt=""/>
</div>
<p>A primary-listener is employed called <code>ColorGradientsListener</code>. The primary-listener accepts Json parse events and will relay them to a sub-listener. The sub-listener is implemented to specifically deal with one tier of the inbound data. The sub-listeners are structured in a stack where the sub-listener at the head of the stack has a pointer to its parent. The primary-listener maintains a pointer to the current head of the stack and will direct events to that sub-listener.</p>
<p>In response to events, the sub-listener can take-up the data, pop itself from the stack or push additional sub-listeners from the stack.</p>
<p>The same approach has been used in the following classes in a more generic manner;</p>
<ul>
<li><code>BJsonTextWriter</code> </li>
<li><code>BJsonMessageWriter</code> </li>
</ul>
<p>The intention with this approach is that the structure of the event handling code in the sub-listeners mirrors that of the data-structure being parsed. Hopefully this makes creating the filling of a specific data-model easier even when very specific behaviours are required.</p>
<p>From a schema of the data structure it is probably also possible to create these sub-listeners and in this way automatically generate the C++ parse code as event listeners.</p>
<h1><a class="anchor" id="writing"></a>
Writing</h1>
<p>In order to render a data-structure as textual Json data, the opposite flow occurs; events are emitted by the client software into a class <code>BJsonTextWriter</code>. This class supports public methods such as <code>WriteFalse()</code> , <code>WriteObjectStart()</code> and <code>WriteString(...)</code> that control the outbound Json stream.</p>
<h1><a class="anchor" id="end-to-end"></a>
End to End</h1>
<p>Because <code>BJsonTextWriter</code> is accepting JSON parse events, it is also a <code>JsonEventListener</code> and so can be used as a listener with the stream parsing; producing Json output from Json input. The output will however not include inbound whitespace because whitespace is not grammatically significant in Json. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
  <hr class="footer"/><address class="footer"><small>
    The Haiku Book pre-R1 - Json Handling<br />
    Generated on Wed Aug 4 2021 13:07:56 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.8.16
  </small></address>
<!-- Fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '../../../metrics.haiku-os.org/tracker.js', 'fathom');
fathom('trackPageview');
</script>
<!-- / Fathom --></body>

<!-- Mirrored from www.haiku-os.org/docs/api/json.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 05 Aug 2021 01:50:23 GMT -->
</html>